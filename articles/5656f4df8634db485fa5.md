---
title: "SOA 1つに集約記事"
emoji: "💬"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

---
title: "AWS SOA モニタリングとレポート / その他"
emoji: "👀"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["AWS","SOA"]
published: false
---

# 分野 1: モニタリングとレポート 22%

## Cloudwatch (重要)
  - データポイント
    デフォルトは、5分間隔。**詳細モニタリング**を有効にした場合、1分間隔。
  - グラフ
    メトリクスの最大2週間分の履歴データから、想定値のモデルを計算でき、この想定値の範囲をバンドとしてグラフに表示します。これらのグラフのURL は保存または共有でき、モニタリングによって発見した異常などは上司に共有することが可能。
  - Cloudwatchに送信するときは、名前空間の指定が必須。
### サービスヘルスダッシュボード
  各AWSのサービスの全体的なステータスを確認するのに適しています。
  （EC2インスタンスのリタイアメント通知の自動設定には利用されません。）
### クロスアカウントクロスリージョンダッシュボード
  複数アカウントおよび複数リージョン***全体の**パフォーマンスおよび運用データを可視化、集計*する。
  ##### ＜注意＞
  リージョン間のデータを収集して(ばらばらに)表示させることは可能だが、**リージョン間のデータの集計はできない**。
### 標準メトリクス
以下は標準メトリクスで監視できる。
- EC2インスタンスのディスクオペレーション数
- ELBとEC2間の 正常に確立されなかった接続数
- S3バケットへのHTTPリクエストの数
### カスタムメトリクス
**OSレベル**の問題チェックなど、標準メトリクスでは収集できないメトリクス。
**CloudWatchエージェント**を使用してメトリクス取得を設定することが必要。
AWS CLIからメトリクス(=監視対象)のモニタリング設定のスクリプトを記述して、そのメトリクスをCloudWatchにプッシュしてモニタリングを開始できる。
  - デフォルトではEC2インスタンスの**メモリ使用率**メトリクスが取得できないため、ユーザーがカスタムメトリクスを設定する必要がある。
  - [EC2 インスタンス]の通常のメトリクスはCloudWatchに自動で取得されていますが、[EC2 Linux インスタンス]のOSのメトリクスとパフォーマンスをモニタリングするためにはCloudWatch上にカスタムメトリクスを取得。
### CloudWatch エージェント
インストールすると、EC2インスタンスなどのシステム内部メトリクスとログファイルの両方を収集できる。
手順1. インスタンスにエージェントをインストール
手順2. CloudWatchへのアクセス許可をもつIAMロールをインスタンスにアタッチ


## Cloudwatch Logs
logs特定のフレーズ、値、またはパターンを⾒つけるためにログをリアルタイムでモニタリング。
**VPCフローログ**や**CloudTrailのログファイル**は、Cloudwatch Logsに連携することで、CloudWatchでモニタリングできる。
### CloudWatch Logsを用いてログ収集を行う手段
1. CloudWatch Logs エージェントを利用する。
  EC2で稼働しているログをCloudWatchに送りたい場合、**CloudWatch LogsエージェントをEC2にインストールし、設定ファイルを変更/エージェントを起動することでCloudWatch Logsへログを送る**ことができます。
2. 各サービスでログを有効化する。
  **CloudWatch Logsをインストールできない、PaaSやSaaS（例えばLambdaやRDSなど）は、コンソール画面でロギングを有効にすると、自動的にロググループが作成され、ログの収集が開始**されます。


## Cloudwatch Events
### ユースケース
- SNS通知をトリガー(実行)できます。
- EC2 インスタンスのリタイアメント通知に応じて、自動でEC2インスタンスを停止する。
  EC2インスタンスのリタイア
  →AWS Healthがキャッチ
  →CloudWatch Eventsを起動し、通知
  →通知をトリガーとして、LambdaでEC2インスタンスを停止する関数を実行
  →EC2インスタンス停止


## CloudWatchアラーム
特定のメトリクスのしきい値に応じたアラーム通知や自動アクションを実行。
- 既存のアラームの名前は変更できない。
- 複数のメトリクスを監視する(1つの)アラームは作成できない。
- アラーム履歴の保持期間は2週間。
### 連携できるサービス
以下のサービスと直接連携することができます。
- **SNS**
- **AWS Chatbot** (slackへ通知 と言われたらコレ)
- **EC2**(再起動など)
- **AutoScaling**
### ユースケース
- サーバの自動的な増減 (**AutoScaling**)
  EC2のCPU等が高騰しているときに、CloudWatch AlarmとAutoScalingを開始することが可能。
  これによって、一時的に高負荷な状態になった場合、AutoScalingの機能によりサーバの台数を増やす。
- サーバの自動的な再起動 (**EC2**)
  EC2が突然応答しなくなった場合など、強制的に再起動やインスタンスの終了を行うことができます。
  これにより、EC2が動かないなどの障害が発生しても、自動的に復旧できるため、復旧作業が不要になります。
- SNSでrootアカウントでのログインを検知する。 (**CloudTrail, SNS**)
  CloudWatchと、**CloudTrail、SNSを連携**させることでログインのモニタリングが可能。
  しがたって、rootログインが行われた際にCloudWatch Alarmを利用してアカウントの持ち主にメールを送付する、といったセキュリティを強固にする使い方が可能。
- 例：モニタリング値を閾値にアラームを設定して、担当者に周知する。 (**SNS**)
（CloudWatchアラーム → SNS → メール通知）
- SNSへ通知した内容をSlackに通知する (**SNS, AWS Chatbot**)
  AWS Chatbotを利用して、CloudWatch Alarmの内容をSlackへ通知する事が可能となりました。

-----

## Cloudtrail
**ユーザの証跡**ログをとる。
**AWSマネジメントコンソールでの操作とAWS APIコール(データの追加、更新、削除など)を記録**。
(**API呼び出しの関する調査・記録**の問題はcloudtrailが関連する可能性大。)
IAMユーザーやロールからのアクセスやAPIアクティビティの監視 はできるが、外部ユーザーからのクロスアカウントアクセスなどの監視 はできない。(→IAM Access Analyzer を使う。)

- デフォルトでCloudTrailのログファイルは、S3サーバーサイド暗号化（SSE）を使用して暗号化されている。
### ログの保存先
  基本はS3。
  Cloudwatch Logsに保存もできる。（S3より割高）
### ログファイルの整合性の検証
  有効にすることで、CloudTrailによる**ログ作成後に、そのログファイルが変更、削除、または変更されなかったかどうか検証可能**になる。
### ログの調査
- S3に保存している場合
  基本的にはAWS Athena。（最も簡単）
  高度な検索をしたい場合は、ElasticSearchService。
- Cloudwatch Logsに保存している場合
  Cloudwatch Logs Insights
### 「組織の証跡」設定
メンバーアカウントに対するCloudTrailによるログ設定が実施される。

-----

## Config
**AWSリソースの構成情報、変更履歴**を記録。（例：未承認の AMI から起動された EC2インスタンスを検知する）
ConfigにSNSを連携すれば、SNSを利用した通知設定が可能。（例：リソースが更新されるとメール通知が実施されて、変更内容が表示できる。）
### Config Rules
ルールに沿った構成変更が行われているかを評価。
- マネージドルール
  AWSで定義・提供している汎用性の高いベーシックルール。
- カスタムルール
  Lambdaをベースとして自分で作成するルール。
#### トリガータイプ
ルール評価実行のタイミング
- 設定変更時
- 定期的

-----

## EC2Rescue for Windows Server
EC2 Windows Serverインスタンス上で動作し、潜在的な問題の診断とトラブルシューティングを行うツール。ログファイルを収集して問題を解決するだけでなく、問題がありそうな部分をプロアクティブに検索することができます。

### AWS Health
AWSのリソース、サービス、およびアカウントの状態をリアルタイムで可視化。

-----

# その他

## X-Ray
アプリケーションが処理する**リクエスト**に関するデータを収集するサービス。
本番環境や分散アプリケーション (マイクロサービスアーキテクチャを使用して構築されたアプリケーションなど) を分析およびデバッグできる。
- リクエスト実行状況の確認ができる
  アプリケーションの実行状況をエンドツーエンドで確認できる。 
- アプリケーションの問題検出ができる
  X-Ray のトレース機能を使ってリクエストのパスをたどると、パフォーマンスの問題の原因と、問題に関係するアプリケーション内の場所を特定できる。
- アプリケーションのパフォーマンスを向上できる
  アプリケーションのパフォーマンス上のボトルネックを特定できます。X-Ray のサービスマップにより、アプリケーション内のサービスやリソースの関係をリアルタイムで表示できる。高いレイテンシーが発生している場所を簡単に検出し、サービスのノードとエッジのレイテンシーのディストリビューションを視覚化し、アプリケーションのパフォーマンスに影響を与える特定のサービスやパスをドリルダウンすることができる。

-----

## Amazon CloudSearch
AWSで完全に管理された検索サービス。高速で非常に拡張性の高い検索機能をアプリケーションに容易に統合できる。

-----

## RDS
- 保管時のRDS DBインスタンスとスナップショットを暗号化するには、**DBインスタンス作成時に**RDS DBインスタンスの暗号化オプションを有効にする。
- インスタンス作成時、**RDS側でSSL証明書が作成され**、DBインスタンスにインストールされる。
- メンテナンスウィンドウ
  RDSのメンテナンスを定期的に実行。
  OSの更新、DBバージョンの更新、サーバーに適用されたパッチの更新が実施される。
- RDS OracleではRDSのリードレプリカ機能ではなく、**Oracle Data Guard**を使用する必要がある。
- マルチAZでは、冗長性が上がるが、パフォーマンスは向上しない。
- トランザクションログの設定はユーザー側で指定できません。基本的に5分ごとに取得。
### メモリ消費を確認する方法
1. FreeableMemory と SwapUsage の両方の Amazon CloudWatch メトリクスを調べて、DBインスタンスの全体的なメモリ使用パターンを把握。
  スワップメモリをモニタリングするには、拡張モニタリングを有効にして、1 秒間隔でメトリクスを確認できる。
2. Performance Insightsを有効にする
  データベースのパフォーマンスに関する問題のトラブルシューティングに役立つ。
  Performance Insights を有効にして SQL を識別し、DBインスタンスで過度のスワップやメモリを消費しているイベントを確認できる。
### RDSコンソールからモニタリングできる項目
DB インスタンスへの**接続の数**
DB インスタンスへの**読み書きオペレーションの量**
DB インスタンスが現在利用している**ストレージの量**
DB インスタンスのために利用される**メモリおよびCPUの量**
DB インスタンスとの間で送受信される**ネットワークトラフィックの量**

## Aurora
- **Aurora Auto Scaling**を使用できる。（リードレプリカを自動的にプロビジョニング）
- マルチAZ構成はない。

## DynamoDB
- Auto Scalingできる。（パフォーマンス向上）
- グローバルテーブル
  **別のリージョン**のユーザーがDynamoDBテーブルのデータに低レイテンシーでアクセスできる。

## Amazon Redshift
データウェアハウス・BI（ビジネスインテリジェンス）のサービス。
- 拡張VPC ルーティング
  クラスターとデータリポジトリ間のすべてのCOPYとUNLOADトラフィックがVPCを通るよう強制できる。
- 監査ログと STL テーブルは、どのユーザーがいつログインしたかなど、データベースレベルのアクティビティを記録。これらのテーブルには、ユーザーが実行した SQL アクティビティとその時期も記録されている。
  - 監査ログ
    S3バケットに保存される。
  - STLテーブル
    クラスターのすべてのノードに保存される。
- クロスリージョンスナップショット
  RedshiftはRDSとは異なり、シングルAZ構成しか実行できなく、マルチAZ構成によるフェールオーバー機能がないため冗長性が低い。**スナップショットを利用してローカルおよびリモートの両リージョンでデータをセキュアにバックアップすることが最良**のソリューション。
  （マルチモードにするとクラスタのノード数を設定できます。複数ノードが利用可能になることで、単一ノード障害への耐久性が向上しますが、複数AZや複数リージョンの構成ができません。）
- Redshiftの**スナップショット低減によるコスト削減**
  Redshiftは、自動スナップショットで定期的にスナップショットを取得しているため、スナップショット量がかさむことで保存コストが増加している可能性がある。

-----

## EC2
- EC2 スポットブロック
  スポットインスタンスを**1~6時間継続して利用できることが担保**された入札形式。
- メタデータを表示するURI
  http://169.254.169.254/latest/meta-data/ 
### AMIを別リージョンで共有
  マネジメントコンソールまたはAWS CLIで、AMIを指定のリージョンにコピーする必要がある。
### インスタンスタイプ
#### 種類
- EBS最適化インスタンス
  EBS I/Oとその他のインスタンスからのトラフィック間の競合を最小化することで、EBS ボリュームの高パフォーマンスを提供。
  (そうでないと、EBSとEC2間の接続がパフォーマンスのボトルネックになる可能性がある。) 
- メモリ最適化インスタンス（r5, r6, x1 等）
  メモリ内の大きいデータセットを処理するワークロードに対して高速。
- コンピューティング最適化インスタンス（c5, c6 等）
  高パフォーマンスプロセッサの恩恵を受けるコンピューティングバウンドなアプリケーションに最適。
- 高速コンピューティング（p3/p4, g3/g4, f1 等）
  機械学習。
- ストレージ最適化インスタンス（h1）
  ビックデータ解析。
#### インスタンスタイプの変更手順
  一旦インスタンスを停止した上で、異なるインスタンスタイプに変更して、インスタンスを再び起動。
### リザーブドインスタンス
#### スタンダード
下記のみ、変更可能。
・アベイラビリティーゾーンまたは適用範囲
・ネットワークプラットフォーム (EC2-Classic または VPC)
・インスタンスサイズ（Linuxのみ）
#### コンバーティブル
属性が変更できる(同等な価格のリザーブドインスタンスに交換できる)。
### 拡張ネットワーキング
高い帯域幅、1秒あたりのパケットの高いパフォーマンス、常に低いインスタンス間レイテンシーを実現。これを有効化することでネットワークパフォーマンスを向上できます。
### プレイスメントグループ
以下のような、インスタンス間における低レイテンシな通信実現するための機能
#### クラスタプレイスメントグループ
  単一AZ内のインスタンスを論理的にグループ化したもの
- **EC2間で低ネットワークレイテンシー、高ネットワークスループット**が発生する場合に最適
- 複数のAZにまたがることはできない
#### パーティションプレイスメントグループ
  論理的なパーティションに分散されているインスタンスのグループ
- 大規模なワークロードに最適（HDFS、HBase、Cassandra）
- 複数のAZに分散させることが可能
#### スプレッドプレイスメントグループ
  それぞれ異なるハードウェアに配置されるインスタンスのグループ
- 少数のEC2が互いに分離して保持される必要があるアプリケーションに最適
- 複数のAZにまたがることが可能
### トラブルシューティング
#### インスタンスを再起動後、すぐに保留状態から終了状態に移行してしまうトラブル
  ストレージが原因。
  1. EBSの容量制限超過
  2. EBSスナップショットの破損
  3. EBSボリュームが暗号化されているが、(復号化するための)KMSキーにアクセスする権限がない
  4. インスタンスを起動するために使用したインスタンスストアバックアップAMIに必要な部分（image.part.xxファイル）がない
#### InsufficientInstanceCapacity(不十分なインスタンス容量)エラー
  InsufficientInstanceCapacityエラーは、現在、リクエストを完了するための十分なオンデマンド容量がないことを示す。
  - 数分待つ。
  - インスタンスの数を減らす。
  - オンデマンド容量予約を作成。
  - 長期の容量予約であるリザーブドインスタンスを購入。
#### CPUクレジットがゼロになり、インスタンス処理が停止したとき
  - 無制限にバースト可能なインスタンスを使い、高いCPUパフォーマンスを維持する。（T3Unlimited や T2Unlimitedなど。t2やt3はバースト可能。）
  - インスタンスサイズを大きなものにスケールアップする。
#### ネットワークパフォーマンスが悪いとき（向上させる方法）
  - より大きなEC2インスタンスサイズを使用する。
  - 拡張ネットワークを実行。（拡張ネットワークをサポートしていないインスタンスタイプがある。m1.small 等）

-----

## AWS Server Migration Connector
## AWS Server Migration Service (SMS)
VMwareを利用した仮想サーバーを Amazon EC2に移行するために利用。
- VMware環境で AWS Server Migration Connector をセットアップ。(移行の準備)
- AWS SMS アクセス許可とロールの設定 を既に完了していることを前提として、SMSを利用した移行プロセスを実行。
  - **VM Importでなく、SMSを使用することがAWSでは推奨されています**。（置き換えできる要件のとき）

-----

## AWSサポート
人的なAWSのサポートサービス。
| プラン種類 | ベーシック | 開発者 | ビジネス | エンタープライズ |
| --- | --- | --- | --- | --- |
| 問合せ方法 | インスタンスのヘルスチェック不合格時のみ | メール | 電話 | 電話, テクニカルアカウントマネージャへの直接問合せ |






---
title: "AWS SOA 高可用性 / デプロイとプロビジョニング"
emoji: "⛴"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["AWS","SOA"]
published: false
---

# 分野 2: 高可用性 8%

## Route53
DNS（＝ドメイン名とIPアドレスを変換（名前解決）するシステム）。
[参考サイト](https://zenn.dev/naoki_mochizuki/articles/d0d9fd2459250baeb37d)
- AutoScalingを直接指定できない。**Route53はELBに対して構成する**。
### レコード情報
- **Aレコード（ホスト名とIPアドレスの関連づけを定義）**
- **AAAAレコード（IPv6 のAレコード）**
- CNAMEレコード（正規ホスト名に対する別名を定義）
- MXレコード（メールサーバーのホスト名を定義）
- NSレコード（ネームサーバー）
- SOAレコード（管理情報の始点レコード）
- **ALIASレコード**：**AWSサービスのエンドポイント**のIPアドレス
### トラフィックルーティング
- レイテンシールーティング
  レイテンシーが最も低いリージョンからのリクエストを処理。
- フェイルオーバールーティングポリシー
  アクティブ/パッシブフェイルオーバーを構成する場合に使用。
### Evaluate Target Health
Evaluate Target Healthフラグを有効化にすると、**ELBのヘルスチェックによってELBの背後にあるEC2インスタンスのレイテンシーを確認して、最適なルーティング**（低レイテンシーが可能なインスタンスへのトラフィック処理の継続）を実施する。
### ヘルスチェック
応答が返ってくるかをチェックする ヘルスチェック をRoute53で作成できる。タイプが3種類ある。
1. **エンドポイント**をモニタリングするヘルスチェック
  IPアドレスあるいはドメイン名で特定するエンドポイントをモニタリング。
2. **他のヘルスチェック**を監視するヘルスチェック
  複数のリソースに対して各ヘルスチェックを用意した状況の場合、それら各ヘルスチェックをチェックし、しきい値より下回らないか確認。
3. **CloudWatchアラーム**をモニタリングするヘルスチェック

-----

## CloudFront
CDN。画像や動画をキャッシュ。
### キャッシュヒット率の改善
- クエリ文字列パラメータに基づいてキャッシュするよう、**オリジンが一意のオブジェクトを返すクエリ文字列パラメータ**のみを転送するように設定。
- **Cache-Control max-ageディレクティブ**をオブジェクトに追加し、max-ageに対して最も長い実用的な値を指定。
### 有効期限が切れる前にエッジキャッシュからファイルを削除したい場合
  aws cloudfront create-invalidation(無効化)コマンドを使用して、エッジキャッシュのファイルを無効化する。
### レポート
1. キャッシュ統計レポート
　エッジロケーションに関連する統計をグラフ表示。
2. 使用状況レポート
　HTTPおよびHTTPSリクエスト数を確認。
3. ビューワーレポート
　物理デバイス+コンテンツにアクセスするビューワーに関する以下の4つのレポートを表示。
・デバイス : ユーザーが最も頻繁に使用するデバイスのタイプ(デスクトップやモバイルなど)。
・ブラウザ : ChromeやFirefoxなど、ユーザーが最も頻繁に使用するブラウザ。
・OS : Linux、Mac OS X、Windows など、ビューワーが最も頻繁に実行するOS。
・ロケーション : コンテンツに最も頻繁にアクセスするビューワーの場所 (国、州)
4. 人気オブジェクトレポート
5. トップリファラレポート
### AWS Nitro Enclaves
**オリジンがELBロードバランサー以外**の場合、信頼されたサードパーティー認証機関 (CA)によって署名された証明書を使用する必要があり、これまではサードパーティーの証明書を利用する必要があった。
しかし、**AWS Nitro Enclavesを使って、ACMで発行したSSL/TLS証明書を使用できる**。

上は、**CloudFrontとカスタムオリジン間** のHTTPS の話。
**ビューアとCloudFront間**の HTTPS は、ACMが提供する証明書 or 認証局（CA）によって発行された証明書を使用できる。

-----

## Elastic Load Balancing
- **ELBはリージョンをまたげないので、Route53を使用**する。
- NLBはPre-warming申請が不要。
### X-Forwarded-Forリクエストヘッダー
**クライアントのIPアドレスを識別**するのに利用。
このヘッダーで**トラフィックをフィルタリングできる**。
### スティッキーセッション
複数のEC2インスタンスを起動している場合、**Cookieを使用してユーザーのリクエストを追跡し、後続のリクエストを同じインスタンスに送信**し続ける機能。
（どのインスタンスにリクエストするかわからないので、スティッキーセッションを設定しないと、ユーザは再ログイン（セッションの頻繁な切断）を頻繁に求められる。）
### Connection Draining
サーバがELBから離脱してもセッションを持ち続ける機能。
**ELBから切り離しても、まだリクエスト中のインスタンスへ指定秒数の間は通信は切れない**。
(新規にリクエストがあっても、既に切り離されたインスタンスへのアクセスはできない。)
デフォルト：*300秒*。最大タイムアウト値は *1 〜 3,600 秒*の間で設定できる。
### アクセスログ
アクセスログの有効化によって、ELBへのリクエストに関する情報を収集できる。
### HTTP応答コードのメトリクス
- HTTPCode_ELB_5XX : ロードバランサーが応答を解析できなかった場合。
- HTTPCode_Backend_4XX : 登録済みインスタンスからクライアントエラー応答が送信された場合。(存在しないリソースにアクセスして404がとなった場合や、Web APIに於いて必須のパラメータが足りなかった場合の400レスポンス等)
- HTTPCode_Backend_5XX : 登録済みインスタンスからサーバーエラー応答が送信された場合。ELB自体に問題が起きた場合、ELB配下に正常(healthy)なインスタンスが1つも無い場合
### ヘルスチェック
ELBヘルスチェックを使用するようにAutoScalingグループを設定すると、ELBヘルスチェックで異常とみなされたインスタンスを、AutoScalingでも異常と判断できる。（→ AutoScalingによって削除され、置き換えられる）
### さばききれなかったアクセス管理
- SpilloverCount
  サージキューがいっぱいとなり**拒否されたリクエスト**の総数を取得。
- SurgeQueueLength
  正常なインスタンスへのルーティングを**保留中のリクエスト** (HTTPリスナーまたはTCPリスナー) の合計数。
- RequestCount
  指定された間隔(1分または5分)の間に完了したリクエストの数または接続の数。
- UnHealthyHostCount
  ロードバランサーに登録された異常なインスタンス数。
### セキュリティポリシー
- Server Order Preferenceが有効になっているポリシー : ELBはポリシーで指定されている順序で暗号化を実施。
- それ以外の場合 : ロードバランサーはクライアントによって提示された順序で暗号を使用します。

## AutoScaling
**マルチリージョンに利用できない。1つのリージョン内でマルチAZで利用できる。**
- リクエストを変更されたヘッダーを持つバックエンドインスタンスに転送するケースでは、フロントエンド接続とバックエンド接続の両方にHTTPを使用することが求められます。
#### 一定期間メトリクスが取得できなくなる場合
ステップスケーリングポリシーを使用した場合。（ウォームアップ中）
指定されたウォームアップ時間が経過するまで、新しく起動されたインスタンスはAuto Scalingグループの集約メトリックにカウントされないため。
#### データベースサーバーをインターネットからのアクセスから保護する場合
WEBサーバーはパブリックサブネットに設置し、DBサーバーはプライベートサブネットに設置する2層アーキテクチャーが一般的な構成。
その際に**ALBなどのロードバランサーを両方のサブネットに設定**します。
（リクエストの流れ：パブリックのロードバランサー→WEBサーバー→プライベートのロードバランサー→DBサーバー）
#### AddToLoadBalancer
AutoScalingによってインスタンスが追加されたとき、**インスタンスをELBのターゲットグループに設定する機能**。
しかし、これを中断している最中にAutoScalingによってインスタンスが追加されると、それらのインスタンスはロードバランサーやターゲットグループに追加されません。
AddToLoadBalancerプロセスを再開すると、**このプロセスが中断されている間に起動されたインスタンスは**追加されないままとなりますので、これらのインスタンスは**手動で登録する必要**があります。

-----

# 分野 3: デプロイとプロビジョニング 14%

## 用途の違い
- **ElasticBeanstalk**
  アプリケーションをデプロイするための方法。
  **WEBアプリケーションのデプロイ**と管理を**自動化**する。
- Opsworks
  アプリケーションスタックをデプロイするための方法。
  サーバーのパッチ適用、アップデート、バックアップが自動的に実行される。
- **Cloudformation**
  AWSリソースをデプロイするための方法。
  **AWSリソース**管理、構築を**自動化**する。
  サーバーのパッチ適用、アップデート、バックアップは自動化できない。（Opsworksはする）

## ElasticBeanstalk
負荷分散、オートスケーリング、リソースのモニタリング、クラスター全体へのコンテナの配置などを自動で実行。
### ログについて
- 環境管理コンソールまたはeb logs を使用して**ログ末尾をリクエストすると、ログをテキストファイルにまとめてS3にアップロード**する。**S3へのログローテーションを有効化**することも可能。
（→S3バケットへのアクセス権限を限定して対象者にログファイルのみを閲覧させることもできる。）
- **CloudWatch Logsへログをリアルタイムでストリーミング**することもできる。

-----

## Cloudformation(重要)
CloudFormationがスタック作成に失敗した場合、スタックは自動的にロールバックされる。
### ドリフト
  テンプレート と 展開したインフラ との相違点。
  スタックでドリフト検出オペレーションを実行すると、スタックが予想されるテンプレート設定からドリフトしたかどうかが判断され、ドリフト検出をサポートするスタック内の各リソースのドリフトステータスに関する詳細情報が返されます。
### セクション
- Resources
  スタックに含めるAWSリソースを宣言。必須。
- Mappings
  リージョンに応じてAMIを選択することが可能。
- Outputs
  他のスタックにインポートする (クロススタック参照を作成)、応答として返す (スタック呼び出しについて記述)、またはCloudFormationコンソールで表示する出力値を宣言。
- Conditions
  エンティティが作成または設定される状況を定義。
  たとえば、条件を作成し、それをリソースまたは出力に関連付けることで、条件がtrueの場合にのみ、CloudFormationがリソースまたは出力を作成するようにできる。
### スタックの更新方法（2通り）
1. **直接更新**を実施する
  更新をスタックにすぐにデプロイしたい場合。  
  テンプレートを送信するか、スタック内のリソースに対して更新を指定する入力パラメータを送信するとCloudFormationによりすぐにデプロイされる。
  インフラ構成が正しくプロビジョニングされ、かつサービスの中断を回避する必要がある場合には不適合。
2. **変更スタック**を設定して実行する
  変更セットによってスタックを更新する。（スタックを削除して新しいスタックを作成するのではなく）  
  変更セットを使用すると、スタックの変更案が実行中のリソースに与える可能性がある影響 (変更によって重要なリソースが削除されたり置き換えられたりしないか等) を確認できる。
### リソース属性
- **CreationPolicy属性**
  **アクションが完了した後にのみ、CloudFormationがスタックの作成を続行できる**ように設定が可能。（例：インスタンスが動いていることを確認してから、○○する。）
  - ResourceSignalパラメーター
    Timeoutプロパティを追加することで、前提条件となるAWSリソースが起動されるまでのタイムアウト時間(待機時間)を設定できる。
- **DependsOn属性**
  特定のリソースが他のリソースに続けて作成されるように指定できます。DependsOn属性をリソースに追加した場合、**そのリソースの作成は必ず、DependsOn属性で指定したリソースの作成後**に行われます。(dockerのdependsに近い)
- **UpdatePolicy属性**
  新バージョンの更新する際に事前処理などを指定することで、**ダウンタイムを抑える**対応を実施することが可能。
  （例：CloudFormationスタックが更新されるときのAutoScalingグループリソースの更新方法を定義。）
- AutoScalingRollingUpdateポリシー
  CloudFormationがAutoScalingグループのローリング更新を処理する方法を制御できます。この共通的なアプローチでは、**同じAutoScalingグループを保持し、設定したパラメータに基づいて古いインスタンスの置き換え**を行います。 
- **UpdateReplacePolicy属性**
  スタック更新オペレーションでリソースを**置き換えるとき**に、リソースの**既存の物理インスタンスを保持**したり、必要に応じて**バックアップ**したりします。
- **DeletionPolicy属性**
  スタックが**削除された**際に**リソースを保持またはバックアップ**できます。
### ヘルパースクリプト
スタック内のEC2インスタンスの構築・変更を行うためのもの。
- cfn-init
  AWS::CloudFormation::Initキーからテンプレートメタデータ(変数)を読み取り、それに応じて次のような操作を行います。（現在は、**SystemsManagerのStateManagerの利用が推奨**されている。）
  ・AWS CloudFormationのメタデータの取得と解析
  ・パッケージのインストール
  ・ディスクへのファイルの書き込み
  ・サービスの有効化/無効化と開始/停止 
- cfn-get-metadata
  **CloudFormationリソースからメタデータを取得**できる。
- cfn-signal
  CloudFormationに信号を送り、EC2インスタンスが正常に作成または更新されたかどうかを示す。
  つまり、**cfn-signalヘルパースクリプトの信号を確認して、直前のタスクが終了したのを確認した上で、次のリソース設定を始める**ことが可能。
  (例：リソース作成開始から30秒以内にシグナルが飛ばない場合、ロールバックする みたいに使う。)
- cfn-hup
  **リソースのメタデータの変更を検出し、変更が検出された場合は、ユーザーが指定した操作を実行するデーモン**。
  これによって、実行中のEC2インスタンスで UpdateStack APIアクションを通じて設定を更新することができます。
### CloudFormationに依存してリソースをプロビジョニングするサービス
（プロビジョニング : 需要を予想しリソースを調達すること。 サイトアクセス数を見積もってそれに応じたスペックのEC2インスタンスでWebサーバを用意する等）
- **Elastic Beanstalk**
- **SAM（サーバーレスアプリケーションモデル）**
### スロットリングエラー
- スロットリングとは : 一定時間内に受信可能なリクエスト数を制限し、制限を上回るリクエストがなされた際には受信を拒否しエラーコードを返却すること。時間経過により再び受信可能となる仕組み。
- 原因 : スタック作成用のAPIが同時に多くのリソースを作成していること。
- 対処 : 指数バックオフと呼ばれる処理方法を使用して、リクエスト間に遅延を追加する。
  




---
title: "AWS SOA セキュリティとコンプライアンス / ネットワーク"
emoji: "🔑"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["AWS","SOA"]
published: false
---

# 分野 5: セキュリティとコンプライアンス 18%

## IAM ※特に重要
### IAMロール
リソース(A)に対して、一時的にリソース(B)へのアクセスを許可。（IAMユーザの、対象が人じゃないバージョン。）
  - 権利の委譲
  - **原則：アクセスキーよりIAMロール**
### IAMポリシー
IDやリソースに関連付けてアクセス許可を定義。
- IDベースのポリシー
  **IAMユーザー、グループ、ロール**にアタッチ。
  そのアイデンティティが実行できる内容 (そのアクセス許可) を指定できる。
  「何に対して、何を実行できるか」(誰は ＝ self)
- リソースベースのポリシー
  **リソース**にアタッチ。
  特定のIAMユーザーやアカウントに対するアクセスを制御できる。たとえば、バケットポリシーをS3バケットにアタッチして、アクセスするIAMユーザーを限定することができる。
  「誰は、何を実行できるか」(何に ＝ 基本は、self)
### 信頼ポリシー, アクセス許可ポリシー
わかりやすく説明できないので、次のケース例で説明。
- ケース
  自社でAWSアカウントを「開発用」「本番用」の二つ持っている。
  開発者(IAMユーザー)は開発用アカウントに所属して作業を行っているが、必要に応じて本番用アカウントの S3 バケット にアクセスしたい。
- フロー
  1. 「本番用アカウントの管理者」が「開発用アカウントへの信頼ポリシー」を定義したロールを作成し、 ロールのアクセス許可ポリシーで「S3 バケットに対するユーザーの読み取りと書き込みのアクセス」を指定する。
  2. 「開発用アカウントの管理者」が「開発用アカウント内の開発者グループのメンバー」に対して、1のロールに切り替えるアクセス許可を付与する
  3. 「開発用アカウント内の開発者グループのユーザー」がロールの切り替えをリクエストして、一時的に認証される
  4. 3のユーザーが、ロールを使用して本番用アカウントの S3 バケット にアクセスする
  5. 3のユーザーがロールの使用を終了し、元のユーザーアクセス権限に戻る
#### 信頼ポリシー
IAMロールにアタッチされる。設定した対象に、操作を許可する。
#### アクセス許可ポリシー
IAMユーザーにアタッチされる。
一時的に、何かのリソースに特別にアクセスできる。
### サービスコントロールポリシー (SCP) 
組織を管理するために使用できるポリシーのタイプ。
リソースのアクセス権限を組織単位でコントロールすることに利用。（ユーザー単位ではない）

SCPをOU(組織単位)にアタッチする(ガードレールを敷く) + IAMポリシーを付与(実際に権限を与える)  
→  IAMユーザーの操作権限は、SCPとIAMの両方で許可されている場合に対象リソースの実行が可能。
つまり、**両方で 明示的に許可され かつ 明示的に拒否されていない** 場合に許可される。
##### 例
- SCP：EC2とRDSの全ての操作権限が許可
- IAMポリシー：EC2の削除権限のみをDeny、その他のEC2操作をAllow
→ 両方が明示されている「EC2インスタンスの削除 以外の操作」が実施できる。
### パワーユーザー
管理者権限以外のあらゆるAWSリソースに対する権限を有したユーザー。
（フルアクセスは、管理者権限も持つ。）
### AWS CLIを操作するために必要な情報
- アクセスキー
- シークレットアクセスキー
- リージョン
### 認証情報レポート (IAMコンソール)
  アカウントのすべてのユーザーと、ユーザーの各種認証情報 (パスワード、アクセスキー、MFA デバイスなど) のステータスが記載されているレポートを取得できる。

## Certificate Manager(ACM) 
- **ACMがサポートされていないリージョンでは、IAM を Certificate Manager として使用する必要がある**。
- IAM APIを使用して証明書を取得するには、get-server-certificateコマンドを使用して、証明書のARNを取得。
- 取得した証明書をELBに設定するためには、set-load-balancer-listener-ssl-certificateコマンドを使用して証明書を設定。
- ACMは**期限切れ前に自動的に証明書を更新する**。
- ACMは**ELBと統合して、ロードバランサーに証明書をデプロイできる**。

-----

## AWS Shield
マネージド型の**分散サービス妨害(DDoS)を防御**するAWSサービス。

**<注> SQLインジェクション、クロスサイトスクリプティング（XSS）、DDoS攻撃への対応としては、AWS Shield とWAFによる対応が不可欠。**
- スタンダード
  無料。通常、Cloudfrontなどを利用すると自動で適用される。
- アドバンスト
  アプリケーションを標的とした攻撃に対する高レベルな保護。**リアルタイムのモニタリング**が必要な場合に使用。

## WAF
ウェブエクスプロイトからウェブアプリケーションを保護するために役立つファイアウォール。
ルールを設定してルールがマッチしたアクセスを遮断する機能。（*監視はできない。*）
- 守れるもの
　・SQLインジェクション攻撃
　・クロスサイトスクリプティング攻撃
　・OSコマンドインジェクション攻撃
　・DDoS攻撃

AWS **WAFはOSI参照モデルの7層**で行われるDDos攻撃を緩和できますが、
AWS **Shieldは3層および4層**で行われるDDos攻撃からWebサービスを防御します。

## インポートキーペア
利用している**キーペアの複製を別リージョンに移行**することで、既存キーペアを利用できる。
（AMIを新しいリージョンにコピーしてインスタンスを作成すると、別のリージョンで作成した既存のキーペアを選択することができません。そのため、基本的には新しいリージョンでは新規キーペアを作成することになります。しかしながら、現在のリージョンで利用しているPEMキーを共有したいという場合は、**PEMキーを別リージョンにインポートすることができます**。）

-----

## 暗号化
- サーバサイド暗号化：オブジェクトを保管時に暗号化する場合。
### CSE (Client Side Encryption)
クライアント内で暗合化したオブジェクトをS3に登録して、暗号化キーの生成と管理はクライアント側で実行します。
### SSE-C (サーバサイド)
AWS側の暗号化キーではなく、ユーザが作成・管理する暗号化キーによって暗号化を実行。
### SSE-S3 (サーバサイド)
AWS S3で管理された暗号化キーによるサーバーサイド暗号化。
### AWS KMS
  AWSサービスとしてキーの作成と管理をマネージド型サービスで提供。
#### KMS キーポリシー
  KMSの発行する**カスタマーマスターキーにアクセスできるユーザーを管理・変更**できる。
### AWS CloudHSM
  **大規模システム用**。**KMSではダメな、特殊な場合**に使う。
### NGなパターン
- 暗号化キーを、暗号化されたデータと一緒に保存。（一方が侵害された場合のセキュリティリスクが高い）
- 外部ハードウェアデバイスに暗号化キーを保存。（そのハードウェアが侵害された場合）

-----

## Guard Duty (検知)
セキュリティの観点から、VPCフローログなどのトラフィックデータを機械学習などを利用して自動で解析して、不正なアクセスを**検知**。(トラフィック制御はできない)
- **機械学習を利用した不正検知**が可能です。 
- **VPCフローログを解析**できます。 
- **IPアドレスやドメインリストを解析**できます。 
「実際のログを分析して脅威が存在するかをチェックする」もの

## Inspector (評価)
⾃動**セキュリティ診断**サービス。
対象が**EC2インスタンスのみ**。（AWSの他のリソースを評価することができない）
「実際に攻撃を受けるとどうなるかをチェックする」もの

-----

## Artifact
AWSとの**契約やコンプライアンス**などに関わる情報を一元管理することができるサービス。**監査**対応。(CodeArtifact は全く関係ない)
1. レポート機能
ISO認定、PCI(Payment Card Industry)、SOCレポートなどの **AWSセキュリティ・コンプライアンスドキュメント**をダウンロードできる。
2. 契約に関する機能
AWSとの契約を確認・管理。複数のアカウントに紐づく契約を管理。

-----

## [認証, 認可の前提知識]
### Single Sign-On(SSO)
１つのアカウントで複数のクライアントを利用する仕組み。
（例: 別のサービスでログインすれば、連携している他のサービスにもログインできる。）
### SSOを実現するための方法
1. ケルベロス認証方式: ケルベロス認証を利用する
2. エージェント方式: 認証を代行する「エージェント」モジュールを組み込む
3. リバースプロキシ方式: リバースプロキシサーバー + エージェント型
4. フェデレーション方式: ユーザ認証結果を他の認証基盤に渡す（ID フェデレーション = ID認証）
  
  4.1. **Open ID Connector**(ウェブIDフェデレーション)
    Webアプリケーション等を公開するときに、いちいち1ユーザ当たりにそれぞれIAMユーザを払い出したくない場合。(Google・Facebook等)
    → **AWS Cognito, AWS STS**

  4.2. **SAML2.0**
    異なるドメイン間でユーザー認証を行うための XMLをベースにした標準規格。
    オンプレミス等でID管理サーバが**SAML2.0**に対応している場合
    → **AWS Cognito, AWS SSO**

  4.3. **AD Connector**
    **Active Directoryドメイン**とAWSのIAMによるユーザー管理を連携できます。
    その上で、**シングルサインオンを有効にする**ことで、AWSマネジメントコンソールとAWSコマンドラインインターフェイス（CLI）への**SSO**を設定できます。
    オンプレミス等で**ActiveDirectory**を使用している場合。
    → **AD Connector** (すでにActiveDirectoryを使用している場合はCognitoは使わず、AD Connectorを使う。)

## AWS Cognito
ユーザ認証を提供。
下記2種のIDプロバイダーを使用したサインインをサポート。
- ソーシャルIDプロバイダー（Facebook、Google、Amazonなど）
- SAML 2.0 によるエンタープライズIDプロバイダー
## AWS STS(Security Token Service)
一時的なセキュリティ認証情報を生成するサービス。
STSによる一時認証方式 : ウェブID フェデレーション

## AWS Single Sign-On (SSO) 
**社員に対する認証向け。(SAML対応)**
複数のAWSアカウントやアプリケーションへのSSOアクセスを簡単に一元管理できるクラウドSSOサービス。
これにより、ユーザーはAWS SSOで構成する資格情報か既存の社内認証情報を使用してユーザーポータルにサインインし、割り当てられたすべてのアカウントとアプリケーションに1か所からアクセスできます。
AWS SSOでは、OrganizationsのすべてのアカウントへのSSOアクセスとユーザーアクセス権限の一元管理が簡単になります。
また、SSOアプリケーション設定ウィザードを使用することで、SAML 2.0 の統合を作成し、SSOアクセスを任意のSAML対応アプリケーションに拡張できます。
社内の既存の Microsoft Active Directory (AD)のIDを使用して、アカウントとアプリケーションへのSSOアクセスを管理できます。
AWS SSOはAWS Directory Serviceを通じてADと統合されるため、ユーザーを該当するADグループに追加するだけでアカウントとアプリケーションへのSSOアクセスをユーザーに許可できます。

-----

## Well-Architected Frameworkで提唱されている5つの設計原則
1. Reliability：回復性の高いアーキテクチャを設計する
2. Performance Efficiency：パフォーマンスに優れたアーキテクチャを定義する 
3. Security：セキュアなアプリケーションおよびアーキテクチャを規定する 
4. Cost Optimization：コスト最適なアーキテクチャを設計する。
5. Operational Excellence：オペレーショナルエクセレンスを備えたアーキテクチャを定義する。

※ 会社の基幹システムとなるインフラ構成にはサーバレスアーキテクチャではなく、通常のサーバーによる構成が必要とされます。

## セキュリティに関する 設計原則とベストプラクティス
### 7つの設計原則
1. 強固な認証基盤の整備
2. 追跡可能性の実現
3. 全レイヤーへのセキュリティ適用
4. セキュリティのベストプラクティス自動化
5. 転送中および保管中のデータの保護
6. データに人を近づけない
7. セキュリティイベントに対する準備
### 5つのベストプラクティス
1. アイデンティティとアクセス管理
2. 発見的統制
3. インフラストラクチャ保護
4. DDos攻撃を緩データ保護
5. インシデント対応

-----

## 責任共有モデル
### AWS責任
- ハードウェアの物理的セキュリティ
- ネットワークインフラストラクチャ
  データセンターとリージョンを接続するAWSグローバルネットワークを流れるすべてのデータは、安全性が保証された施設から外部に通信される前に物理レイヤーで自動的に暗号化される。
- 仮想化インフラストラクチャのセキュリティ
  AWS側のインフラ環境は仮想化ソフトウェアでフィルタリングすることにより、ユーザーからはユーザーに割り当てられていない物理ホストまたはインスタンスにアクセスできない。
- インフラのパッチ対応・管理
  AWSはインフラストラクチャへのバッチ管理やマネージド型サービスへのバッチ適用を担当する。
- インフラ構成管理
  AWSはデータセンターにおけるインフラを管理する。
- データの所有権
  ユーザーが配置したAWSクラウド内のデータの所有権はユーザーが保持。（= AWSはユーザーの管理するデータにアクセスしない）
### ユーザ責任
- VPCネットワーク内の暗号化やセキュリティ対応
- 保管中のデータのセキュリティ


# 分野 6: ネットワーク 14%

**原則：セキュリティグループは、許可のみ行う。ステートフル**  
**原則：ネットワークACLは、明示的な拒否を行う。ステートレス**
特定のポートを介した特定のIPアドレスからの攻撃に対しては、*ネットワークACL*で防御。

## VPC
- **IPv6 CIDRブロックのサイズ(/56)は固定**。(独自のIPv6アドレス範囲を指定できない)
### VPCピアリング
2つのVPC間をセキュアに通信できる。
（例：異なるアカウントによって所有され、かつ別のリージョンのVPCで稼働されているインスタンス に、パブリックインターネットを通過せずにアクセスできる。）
### ネットワークACL
- 一時ポート(エフェメラルポート)使用時のアウトバウンド設定
  アウトバウンドのポート範囲**1024〜65535** を開放する。
  そうすることで、クライアントがサーバーに接続すると、一時ポート範囲（1024〜65535）からのランダムポートがクライアントのソースポートになる。
### VPCエンドポイント
VPC外のサービス(S3、DynamoDB)と接続する場合に使用。
### インターネットゲートウェイ
インターネットゲートウェイをサブネットに関連づけるとそれはパブリックに、インターネットに通信できる。（パブリックIPも必要）
### NATゲートウェイ
プライベートサブネットからセキュアにインターネットへ通信するために、パブリックサブネットに配置するもの。
設定は、**プライベートサブネットのEC2インスタンスのアウトバウンドを、NATゲートウェイに送信する**ようにする。
### Egress-only Gateway (Egress-onlyゲートウェイ)
**IPv6**を使用してインターネットに出たいときに使用するもの。(IPv6とくればコレ)
しかし、インターネットへのEgress(送信)のみでIngress(受信)はできません。
（NATゲートウェイのIPv6バージョンのようなもの。）
### AWS上のリソースに外部ネットワークへの接続を提供するもの
- インターネットゲートウェイ(IGW)
- 仮想プライベートゲートウェイ(VGW) **<オンプレに繋げる>**
  - DirectConnect
  - VPN
    - AWSのVPN接続には、デフォルトで**2つのVPNトンネル**が利用される。これは最初のVPNトンネルに障害が発生した場合やメンテナンスにより停止している場合などに自動的に2番目のVPNトンネルにフェイルオーバーするように設定されている。 
    - **VPNゲートウェイとカスタマーゲートウェイの作成が必要**。
### セカンダリーENI
  フェールオーバー時にセカンダリーENIへと移行させることで、IPアドレスの切り替えが可能。
  ENIにセカンダリープライベートIPアドレスを割り当てる。
  (Elastic Network Interface = 仮想ネットワークカード(NIC))
### ルートのブラックホール状態(現象)
ルートのターゲットが利用できない状態。
**ルートテーブルに設定したインターネットゲートウェイやNATゲートウェイを削除**すると発生。
### サブネット同士が通信できない場合
次の順番で確認する。
1. インスタンスが正常に動作しているか確認する
2. ネットワークACLで許可されているか確認する
3. VPCフローログが有効な場合はログをチェックする
### VPC間でping出来ない場合
- ping : UDP(ICMP)
セキュリティグループで許可しているか
ネットワークACLで許可しているか






---
title: "AWS SOA ストレージおよびデータの管理 / 自動化と最適化"
emoji: "🧰"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["AWS","SOA"]
published: false
---

# 分野 4: ストレージおよびデータの管理 12%

## S3(重要)
- オブジェクトは**同一のS3リージョン内の複数施設に分散した複数のデバイス**に保存される。
- ストレージクラス分析
  アクセスパターンを分析し、適切なデータをいつ適切なストレージクラスに移行すべきかを判断できる。
- アクセスログ
  アクセスログを有効化することで、S3バケットに対するリクエストの詳細が記録されます。これにより、セキュリティやアクセスの監査に役立ちます。
- rbコマンド(remove bucket)
  バケットのバージョニングが有効化されていない場合にのみ、rb --force コマンドで、空ではないバケットを削除できる。このコマンドは、すべてのオブジェクトを削除した後にバケットを削除する。
- 5xxエラーを解決するには
  ・リクエストするアプリケーションの再試行メカニズムを有効にする
  ・リクエスト率を徐々に増やすようにアプリケーションを設定する
  ・複数のプレフィックスにオブジェクトを分散する 
  ・数百万のバージョンがあるオブジェクトが存在しているか確認する
- マルチアップロード
  大容量オブジェクトのアップロードを効率よく行える。
- クロスオリジンリソース共有(CORS)
  別のドメインで読んだHTML内のJavascriptによるリクエスト（読み込み）を許可。
  そうすることで、JavaScript内のAjax通信でクロスドメインのS3から情報をダイレクトに取得できる。
- **S3の暗号化には、サーバサイド暗号化が使える**。（SSE-S3, SSE-KMS, SSE-C）
### S3 イベント通知機能
  バケット内で特定のイベントが発生したとき、通知を設定することが可能。
  - イベント元：データの**登録・削除・更新**など
  - イベント先：**SNS, SQS, Lambda**
### S3へのアクセス制御(3種)
 1. アクセスコントロールリスト (ACL) 
  **バケット単位とオブジェクト単位**でのアクセス制御。
  （バケットポリシーはバケット単位。）
  ・READ : バケット内のオブジェクトをリストできる。
  ・WRITE : バケット内のオブジェクトを作成、上書き、削除できる
  ・READ_ACP : **バケットACL**を読み取ることができます。
  ・WRITE_ACP : **バケットのACL**を書き込むことができます。
  ・FULL_CONTROL : バケットのREAD、WRITE、READ_ACP、およびWRITE_ACP権限を許可。
 2. バケットポリシー
  **バケット単位**でのアクセス制御。
 3. IAMロール
  **ユーザ単位**でのアクセス制御。ポリシーを使い、ロールを用意する。
### S3 Select
  S3バケット内に保存したオブジェクトに対し、SQL文を用いてデータの一部分のみを取り出すことができるサービス。
### S3インベントリ
  バケットに保存されているすべてのオブジェクトの**複製(バージョニング)および暗号化ステータスに関するレポートを生成**することが可能。

### Glacier deep archive
Glacierより更に安価・アクセスが少ないデータ保存に適したストレージクラス。
取り出しに12時間かかる。

## Amazon Athena
標準SQLを使用してS3バケットにホストされている**データを分析し、レポートを作成**できる。

---

## EBS
- EBS最適化
  EBS最適化をサポートするインスタンスタイプを選択することでEBSでのデータ処理パフォーマンスの改善ができる。
- 初期化
  新しいEBSボリュームは、利用可能になった時点で最大のパフォーマンスであり、初期化を必要としません。
  しかし、**スナップショットから復元されたボリュームは、ブロックにアクセスする前に初期化する必要があります**。各ブロックに最初にアクセスした際は、I/O操作のレイテンシが大幅に増加する可能性があるため。
  この状況はデータに1回アクセスするとパフォーマンスが復元されます。実稼働環境では、**ボリュームを使用する前にすべてのブロックからの読み取りを実行**することで、このパフォーマンスヒットを回避できます。このプロセスは初期化と呼ばれます。
### 種類
- プロビジョンドIOPS SSD (1,000 MiB/秒)
  主な用途 : データベースのサーバー向けのボリュームなど。
- スループット最適化HDD (500 MiB/秒)
  汎用SSDより安価。
  HDDタイプのボリュームであり、SSDタイプのボリュームと比べるとレイテンシーが高いですが、Cold HDDと比較すると高速にデータを読み書きできます。
  高いスループットを必要とする、アクセス頻度の高いワークロード向けの低コストのHDD。
### RAID
- RAID0
  複数のボリュームを1つと捉える。ボリュームを追加すると、スループットとIOPSを追加したことになりI/Oパフォーマンスが向上。
- RAID1
  **耐久性を向上させるミラーリング構成**。
### EBS(EC2)をモニタリングするときの項目
- EBSReadOps
  インスタンスで利用できるすべてのEBSボリュームでの、完了した読み取り**操作の数**を取得。
- EBSWriteOps 
  インスタンスで利用できるすべてのEBSボリュームでの、完了した書き込み**操作の数**を取得。 
- EBSReadBytes 
  インスタンスで利用できるすべてのEBSボリュームでの、読み取られた**バイト数**を取得。 
- EBSWriteBytes 
  インスタンスで利用できるすべてのEBSボリュームでの、書き込まれた**バイト数**を取得。

---

## EFS
- ライフサイクル管理
  選択したライフサイクルポリシーにもとづいて、**保存データを自動的に低価格なEFS IAストレージクラスに移動させることができる**。（S3のように）

## インスタンスストア
インスタンスストアのバックアップは、インスタンスストアのデータを**新しく作成したEBSにコピー**する。（インスタンスストアはスナップショットは作れない）

## StorageGateway
オンプレミス環境に接続することで、オンプレミスサーバからiSCSIを利用してEBSに接続したり、NFSを利用してS3に接続したり、AWSのストレージと接続してデータを移行することが可能。
- **キャッシュ型**ボリューム
プライマリーデータ保存場所：**S3**
- **保管型**ボリューム
プライマリーデータ保存場所：**ローカルディスク**

---

## Snow ファミリー
### Snowball
特徴：コンピューティング能力が高い。
#### Snowball Edge Storage Opimized
ストレージ容量は100TBであり、利用可能領域は80TB。
約1週間
#### Snowball Edge Compute Opimized
ユースケースとして、機械学習、映像の処理・分析など。主にAWSへ転送する前段階で使用。
42TB。
転送は可能ですが、速度が求められる場合はStorage Optimizedがおすすめ。
### Snowcone
特徴：持ち運びのしやすい小型サイズ。
### Snowmobile
特徴：データ転送に特化した大型コンテナ。
超大容量データをAWSに移動するエクサバイト規模のデータ転送サービス。セミトレーラートラックが牽引する長さ 14mの丈夫な輸送コンテナとなっており、Snowmobile1台あたり100PBまでのデータを転送できます。


# 分野 7: 自動化と最適化 12%

## TrustedAdvisor(重要)
下記の観点で**AWS環境を分析**し、最適化するためのベストプラクティスを提供。（情報提供のみで、実行は別途必要。）
### コスト最適化
使われていないリソース (= 無駄なコスト) を検出するほか、利用状況を分析して、コスト削減が期待できる割引プランをおすすめ。
- EC2 リザーブドインスタンスの最適化
- アイドル状態の Amazon RDS DB インスタンス
- 使用率の低い Amazon EC2 Instances
- 関連付けられていない Elastic IP Address
### パフォーマンス
パフォーマンス低下に繋がる使い方をしていないかどうかチェックするほか、もっと効率がよい AWS の機能を使う余地がある場合にお知らせ。
- Amazon EC2 から EBS スループット最適化
- EC2 インスタンスセキュリティグループルールの増大
- 使用率の高い Amazon EC2インスタンス
- 利用率が高すぎる Amazon EBS マグネティックボリューム
### セキュリティ
セキュリティリスクのある設定になっていないかどうかチェックするほか、現在よりもセキュリティを高められる推奨の設定があればおすすめ。
- セキュリティグループ - 開かれたポート
- AWS CloudTrail ロギング
- Amazon EBS パブリックスナップショット
- IAM アクセスキーローテーション
- ルートアカウントの MFA
- 公開されたアクセスキー
### フォールトトレランス
過去データから復旧できるようにバックアップを取得しているか、AWS の機能を活用して冗長構成を取れているか、などの点をチェックする。
- Load Balancer の最適化
- Amazon RDS Multi-AZ
- Amazon Route 53 フェイルオーバーリソースレコードセット
- AWS Direct Connect 接続の冗長性
- Amazon EBS スナップショット
### サービス制限
AWS サービス制限の一部 (39 項目) に対して、現在の利用状況と制限値を比較して差分をチェック。
- そもそもサービス制限とは: AWS は各サービスにおいて、ア
カウント毎に利用可能なリソース (EC2 インスタンス台数、
リージョンあたりの VPC 数など) に制限をかけている。

---

## コスト管理
### AWS Organizations 一括請求機能
  他のメンバーアカウントからは、請求情報にはアクセスできない。
### TCO計算ツール (見積り)
  見積もりツール。
  仮想マシン数・サーバー数・データ容量によって計算。
### Cost Explorer (可視化・予測)
コストと使用状況の経時的変化を可視化し、コスト予測をしてくれます。
Cost Explorerは利用状況を可視化して分析する際に利用します。
### コストと使用状況レポート (レポート作成)
ルートアカウントとIAMユーザーが使用した各サービスの利用状況が、時間単位または日単位の明細項目レベルで確認・集計することが可能なレポート。
CSV形式により、ユーザーが指定したS3バケットに保存します。レポートは最低1日に1回以上更新されます。
### AWS Budgets (監視)
予算のしきい値を超えたときにアラートを発信するカスタム予算を設定します。
AWS Budgets を使用して予約の使用率またはカバレッジターゲットを設定し、使用率が設定したしきい値を下回った場合にアラートを受け取ることもできます。
### AWSコンソールの アカウント設定 (アラート)
請求アラートを有効にできる。また請求内容の詳細も確認することが可能。
#### 請求アラートの設定
*ルートアカウント*のAWSコンソールにて、アカウント設定のAWS **Billing and Cost Management**において請求アラートを有効化。（指定額以上になると通知をくれる。）
### TrustedAdvisor (無駄を発見)
(上で記載)

---

## Systems Manager
([参考サイト](https://dev.classmethod.jp/articles/relay-re-introduction-2019-ssm/))
サーバ群を管理する多機能なツールセットの総称。
（範囲が広すぎてどこまでが"AWS Systems Manager"というサービスの中に収めるべきなのかよくわからない）
  - シークレットデータの格納
### 使う前の手順
・SSM Agentの導入(AMIには導入済み) → SystemsManager管理化のインスタンス（マネージドインスタンス）にする
・SSM AgentからSSM APIへの経路確保
・インスタンスへのIAMロールの付与

上記を簡単に実行できるのが、[クイックセットアップ]。
### Patch Manager
OSパッチの管理。セキュリティ関連のアップデートおよびその他のタイプのアップデートの両方に関して、**インスタンスへのパッチ適用プロセスを自動化**します。OSとアプリケーションの両方にパッチを適用できます。
（AWS Batch：バッチコンピューティングワークロード(大規模計算)を実行）
### Systems Manager Automation
自動化ワークフローを構築して、EC2インスタンスおよび他のAWSリソースの**一般的なメンテナンスとデプロイに関する運用タスクを自動化**することが可能。
### Systems Manager パラメータストア
**CloudFormationテンプレートのパラメーターストアセクションで設定することで、Systems Managerのパブリックパラメータストアを参照して最新AMIを取得**できます。
テンプレートやパラメータなど何も変更せずにCloudFormationスタックを更新するだけでリソースの要件に応じて、その時点で最新のAMI IDに更新されます。

## StepFunctions
- ステートマシン : 処理の工程。
- ワークフロー : 可視化ツール。
#### Simple Workflow
Step Functionsが登場してからは**古いサービス**となっており、利用は推奨されていません。一部、Amazon Simple Workflowしか実行できないタイプのワークフローには有効。

## Amazon DLM (Data Lifecycle Manager)
ある作業をスケジューリングして実行できる。











