---
title: "AWS SOA モニタリングとレポート / その他"
emoji: "👀"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["AWS","SOA"]
published: false
---

# 分野 1: モニタリングとレポート 22%

## Cloudwatch (重要)
(未)CloudWatch events、alert機能の理解、データの流れの理解、メトリクス(カスタムメトリクス含む)　の仕組みと導入方法
  - CloudWatch EventsによりSNS通知をトリガー(実行)できます。
  - データポイント
    デフォルトは、5分間隔。詳細モニタリングを有効にした場合、1分間隔。
  - グラフ
    メトリクスの最大2週間分の履歴データから、想定値のモデルを計算でき、この想定値の範囲をバンドとしてグラフに表示します。これらのグラフのURL は保存または共有でき、モニタリングによって発見した異常などは上司に共有することが可能。
  - クロスアカウント
  リージョン間のデータを収集して表示させることは可能だが、
  リージョン間のデータの集計はできない。
  - Cloudwatchに送信するときは、名前空間の指定が必須。
### カスタムメトリクス
**OSレベル**の問題チェックなど、標準メトリクスでは収集できないメトリクス。
CloudWatchエージェントを使用してメトリクス取得を設定することが必要。
AWS CLIからメトリクス(=監視対象)のモニタリング設定のスクリプトを記述して、そのメトリクスをCloudWatchにプッシュしてモニタリングを開始できる。
- デフォルトではEC2インスタンスのメモリ使用率メトリクスが取得できないため、ユーザーがカスタムメトリクスを設定する必要がある。
- [EC2 インスタンス]の通常のメトリクスはCloudWatchに自動で取得されていますが、
[EC2 Linux インスタンス]のOSのメトリクスとパフォーマンスをモニタリングするためにはCloudWatch上にカスタムメトリクスを取得。
### CloudWatch エージェント
インストールすると、EC2インスタンスなどのシステム内部メトリクスとログファイルの両方を収集できる。
### Cloudwatch Logs
logs特定のフレーズ、値、またはパターンを⾒つけるためにログをリアルタイムでモニタリングする。
VPCフローログや、CloudTrailのログファイルは、Cloudwatch Logsに連携することで、CloudWatchでモニタリングできる。
### Cloudwatch Events
- ユースケース
EC2 インスタンスのリタイアメント通知に応じて、自動でEC2インスタンスを停止する。

EC2インスタンスのリタイア
→AWS Healthがキャッチ
→CloudWatch Eventsを起動し、通知
→通知をトリガーとして、LambdaでEC2インスタンスを停止する関数を実行
→EC2インスタンス停止
### CloudWatchアラーム
特定のメトリクスのしきい値に応じたアラーム通知や自動アクションを実行。
- 例：モニタリング値を閾値にアラームを設定して、担当者に周知する。
（CloudWatchアラーム → SNS → メール通知）
### AWS Health
AWSのリソース、サービス、およびアカウントの状態をリアルタイムで可視化します。
### サービスヘルスダッシュボード
各AWSのサービスの全体的なステータスを確認するには適していますが、EC2インスタンスのリタイアメント通知を自動設定するといった構成には利用されません。
### クロスアカウントクロスリージョンダッシュボード
複数アカウントおよび複数リージョン全体のパフォーマンスおよび運用データを可視化、集計する。
### EBS(EC2)をモニタリングするときの項目
- EBSReadOps
  インスタンスで利用できるすべてのEBSボリュームでの、完了した読み取り操作の数を取得。
- EBSWriteOps 
  インスタンスで利用できるすべてのEBSボリュームでの、完了した書き込み操作の数を取得。 
- EBSReadBytes 
  インスタンスで利用できるすべてのEBSボリュームでの、読み取られたバイト数を取得。 
- EBSWriteBytes 
  インスタンスで利用できるすべてのEBSボリュームでの、書き込まれたバイト数を取得。

-----

## Cloudtrail
**ユーザの証跡**ログをとる。
AWSマネジメントコンソールでの操作とAWS APIコール(データの追加、更新、削除など)を記録することができます。
※ 認証情報のレポートは「認証情報レポート」サービスを使用。
- ログファイルの整合性の検証
  有効にすることで、CloudTrailによるログ配信後に、そのログファイルが変更、削除、または変更されなかったかどうか判断することができる。
- デフォルトでCloudTrailのログファイルは、S3サーバーサイド暗号化（SSE）を使用して暗号化されている。
- API呼び出しの関する調査・記録の問題はcloudtrailが関連する可能性大。
TODO: Cloudwatch logs、CloudWatch eventsとの連携

-----

## Config
**AWSリソースの構成情報、変更履歴**を記録。
例：未承認の AMI から起動された EC2インスタンスを検知する
ConfigにSNSを連携すれば、SNSを利用した通知設定が可能。（たとえば、リソースが更新されるとメール通知が実施されて、変更内容が表示できる。）
### Config Rules
ルールに沿った構成変更が行われているかを評価。
- マネージドルール
AWSで定義・提供している汎用性の高いベーシックルール。
- カスタムルール
Lambdaをベースとして自分で作成するルール。
#### トリガータイプ
ルール評価実行のタイミング
- 設定変更時
- 定期的

-----

## X-Ray
アプリケーションが処理する**リクエスト**に関するデータを収集するサービス。
本番環境や分散アプリケーション (マイクロサービスアーキテクチャを使用して構築されたアプリケーションなど) を分析およびデバッグできる。
- リクエスト実行状況の確認ができる
  アプリケーションの実行状況をエンドツーエンドで確認できる。 
- アプリケーションの問題検出ができる
  X-Ray のトレース機能を使ってリクエストのパスをたどると、パフォーマンスの問題の原因と、問題に関係するアプリケーション内の場所を特定できる。
- アプリケーションのパフォーマンスを向上できる
  アプリケーションのパフォーマンス上のボトルネックを特定できます。X-Ray のサービスマップにより、アプリケーション内のサービスやリソースの関係をリアルタイムで表示できる。高いレイテンシーが発生している場所を簡単に検出し、サービスのノードとエッジのレイテンシーのディストリビューションを視覚化し、アプリケーションのパフォーマンスに影響を与える特定のサービスやパスをドリルダウンすることができる。

## EC2Rescue for Windows Server
EC2 Windows Serverインスタンス上で動作し、潜在的な問題の診断とトラブルシューティングを行うツール。ログファイルを収集して問題を解決するだけでなく、問題がありそうな部分をプロアクティブに検索することができます。

-----

# その他

## 責任共有モデル
### AWS責任
- ハードウェアの物理的セキュリティ
- ネットワークインフラストラクチャ
  データセンターとリージョンを接続するAWSグローバルネットワークを流れるすべてのデータは、安全性が保証された施設から外部に通信される前に物理レイヤーで自動的に暗号化される。
- 仮想化インフラストラクチャのセキュリティ
  AWS側のインフラ環境は仮想化ソフトウェアでフィルタリングすることにより、ユーザーからはユーザーに割り当てられていない物理ホストまたはインスタンスにアクセスできない。
- インフラのパッチ対応・管理
  AWSはインフラストラクチャへのバッチ管理やマネージド型サービスへのバッチ適用を担当する。
- インフラ構成管理
  AWSはデータセンターにおけるインフラを管理する。
- データの所有権
  ユーザーが配置したAWSクラウド内のデータの所有権はユーザーが保持。（= AWSはユーザーの管理するデータにアクセスしない）
### ユーザ責任
- VPCネットワーク内の暗号化やセキュリティ対応
- 保管中のデータのセキュリティ

-----

## Amazon CloudSearch
AWSで完全に管理された検索サービス。高速で非常に拡張性の高い検索機能をアプリケーションに容易に統合できる。

-----

## RDS
- 保管時のRDS DBインスタンスとスナップショットを暗号化するには、**DBインスタンス作成時に**RDS DBインスタンスの暗号化オプションを有効にする。
- インスタンス作成時、**RDS側でSSL証明書が作成され**、DBインスタンスにインストールされる。
- メンテナンスウィンドウ
  RDSのメンテナンスを定期的に実行。
  OSの更新、DBバージョンの更新、サーバーに適用されたパッチの更新が実施される。
- RDS OracleではRDSのリードレプリカ機能ではなく、Oracle Data Guardを使用する必要がある。
- マルチAZでは、冗長性が上がるが、パフォーマンスは向上しない。

## DynamoDB
- グローバルテーブル
  **別のリージョン**のユーザーがDynamoDBテーブルのデータに低レイテンシーでアクセスできる。

## Amazon Redshift
データウェアハウス・BI（ビジネスインテリジェンス）のサービス。
- 拡張VPC ルーティング
  クラスターとデータリポジトリ間のすべてのCOPYとUNLOADトラフィックがVPCを通るよう強制できる。
- 監査ログと STL テーブルは、どのユーザーがいつログインしたかなど、データベースレベルのアクティビティを記録。これらのテーブルには、ユーザーが実行した SQL アクティビティとその時期も記録されている。
  - 監査ログ
    S3バケットに保存される。
  - STLテーブル
    クラスターのすべてのノードに保存される。
- クロスリージョンスナップショット
  RedshiftはRDSとは異なり、シングルAZ構成しか実行できなく、マルチAZ構成によるフェールオーバー機能がないため冗長性が低い。スナップショットを利用してローカルおよびリモートの両リージョンでデータをセキュアにバックアップすることが最良のソリューション。
  （マルチモードにするとクラスタのノード数を設定できます。複数ノードが利用可能になることで、単一ノード障害への耐久性が向上しますが、複数AZや複数リージョンの構成ができません。）

-----

## Cognito
Facebook、Google、AmazonなどのソーシャルIDプロバイダー、およびSAML 2.0(異なるインターネットドメイン間でユーザー認証を行うための XML をベースにした標準規格)によるエンタープライズIDプロバイダーを使用したサインインをサポートします。
## Single Sign-On (SSO) 
社員に対する認証向け。
複数のAWSアカウントやビジネスアプリケーションへのSSOアクセスを簡単に一元管理できるクラウドSSOサービス。
これにより、ユーザーはAWS SSOで構成する資格情報か既存の社内認証情報を使用してユーザーポータルにサインインし、割り当てられたすべてのアカウントとアプリケーションに1か所からアクセスできます。
AWS SSOでは、OrganizationsのすべてのアカウントへのSSOアクセスとユーザーアクセス権限の一元管理が簡単になります。
また、SSOアプリケーション設定ウィザードを使用することで、Security Assertion Markup Language(SAML) 2.0 の統合を作成し、SSOアクセスを任意のSAML対応アプリケーションに拡張できます。
社内の既存の Microsoft Active Directory (AD)のIDを使用して、アカウントとアプリケーションへのSSOアクセスを管理できます。
AWS SSOはAWS Directory Serviceを通じてADと統合されるため、ユーザーを該当するADグループに追加するだけでアカウントとアプリケーションへのSSOアクセスをユーザーに許可できます。
## IDフェデレーション
AWS以外で認証されたユーザに権限を委任し、AWSリソースへのアクセスを許可。
下記2パターンある。
- ウェブ認証フェデレーション(AWS Cognito, Google・Facebook等)
- SAMLベースのフェデレーション
## STS(Security Token Service)
STSによる一時認証方式 : ウェブID フェデレーション

### IDフェデレーションの方法とユースケースについて
- Open ID Connector(ウェブIDフェデレーション)	Webアプリケーション等を公開するときに、いちいち1ユーザ当たりにそれぞれIAMユーザを払い出したくない場合。
別名『ウェブIDフェデレーション』と呼ぶこともあります。
- AD Connector	オンプレミス等でActiveDirectoryを使用している場合
- SAML2.0	オンプレミス等でID管理サーバがSAML2.0に対応している場合

-----

## EC2
- インスタンスタイプの変更手順
  一旦インスタンスを停止した上で、異なるインスタンスタイプに変更して、インスタンスを再び起動。
- インスタンスを再起動後、すぐに保留状態から終了状態に移行してしまうトラブルの原因
  ストレージが原因。
  1. EBSの容量制限超過
  2. EBSスナップショットの破損
  3. EBSボリュームは暗号化されており、復号化のためにKMSキーにアクセスする権限がない
  4. インスタンスを起動するために使用したインスタンスストアバックアップAMIに必要な部分（image.part.xxファイル）がない
- ネットワークパフォーマンスが悪いとき（向上させる方法）
  - より大きなEC2インスタンスサイズを使用する。
  - 拡張ネットワークを実行。（拡張ネットワークをサポートしていないインスタンスタイプがある。m1.small 等）
### 拡張ネットワーキング
高い帯域幅、1秒あたりのパケットの高いパフォーマンス、常に低いインスタンス間レイテンシーを実現。これを有効化することでネットワークパフォーマンスを向上できます。
### プレイスメントグループ
インスタンス間における低レイテンシな通信実現するための機能
#### クラスタプレイスメントグループ
  単一AZ内のインスタンスを論理的にグループ化したもの
- **EC2間で低ネットワークレイテンシー、高ネットワークスループット**が発生する場合に最適
- 複数のAZにまたがることはできない
#### パーティションプレイスメントグループ
  論理的なパーティションに分散されているインスタンスのグループ
- EC2で実行する HDFS、HBase、Cassandra といった分散され、レプリケートされた大規模なワークロードに最適
- 複数のAZに分散させることが可能
#### スプレッドプレイスメントグループ
  それぞれ異なるハードウェアに配置されるインスタンスのグループ
- 少数のEC2が互いに分離して保持される必要があるアプリケーションに最適
- 複数のAZにまたがることが可能

-----

## AWS Server Migration Connector
## AWS Server Migration Service (SMS)
VMwareを利用した仮想サーバーを Amazon EC2に移行するために利用。
- VMware環境で AWS Server Migration Connector をセットアップして移行を準備。
- AWS SMS アクセス許可とロールの設定 を既に完了していることを前提として、SMSを利用した移行プロセスを実行。
  - VM Importでなく、AWS Server Migration Serviceを使用することがAWSでは推奨されています。（置き換えできる要件のとき）