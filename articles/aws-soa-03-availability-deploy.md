---
title: "AWS SOA 高可用性 / デプロイとプロビジョニング"
emoji: "⛴"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["AWS","SOA"]
published: false
---

# 分野 2: 高可用性 8%

## Route53
DNS（＝ドメイン名とIPアドレスを変換（名前解決）するシステム）。
[参考サイト](https://zenn.dev/naoki_mochizuki/articles/d0d9fd2459250baeb37d)
### レコード情報
- Aレコード（ホスト名とIPアドレスの関連づけを定義）
- AAAAレコード（IPv6 のAレコード）
- CNAMEレコード（正規ホスト名に対する別名を定義）
- MXレコード（メールサーバーのホスト名を定義）
- NSレコード（ネームサーバー）
- SOAレコード（管理情報の始点レコード）
- ALIASレコード：AWSサービスのエンドポイントのIPアドレス
### トラフィックルーティング
### ヘルスチェック
応答が返ってくるかをチェックする。タイプが3種類ある。
1. エンドポイントをモニタリングするヘルスチェック
IPアドレスあるいはドメイン名で特定するエンドポイントをモニタリング。
2. 他のヘルスチェック (算出したヘルスチェック) を監視するヘルスチェック
複数のリソースに対して各ヘルスチェックを用意した状況の場合、それら各ヘルスチェックをチェックし、しきい値より下回らないか確認。
3. CloudWatchアラームをモニタリングするヘルスチェック

## CloudFront
CDN。画像や動画をキャッシュ。
- クライアントからオリジンまでのデータの流れ、暗号化処理
### キャッシュヒット率の改善
- クエリ文字列パラメータに基づいてキャッシュするよう、オリジンが一意のオブジェクトを返すクエリ文字列パラメータのみを転送するように設定。
- Cache-Control max-ageディレクティブをオブジェクトに追加し、max-ageに対して最も長い実用的な値を指定。
### 有効期限が切れる前にエッジキャッシュからファイルを削除したい場合
aws cloudfront create-invalidation(無効化)コマンドを使用して、エッジキャッシュのファイルを無効化する。
### レポート
1. キャッシュ統計レポート
　エッジロケーションに関連する統計をグラフ表示。
2. 使用状況レポート
　HTTPおよびHTTPSリクエスト数を確認。
3. ビューワーレポート
　物理デバイス+コンテンツにアクセスするビューワーに関する以下の4つのレポートを表示。
・デバイス : ユーザーが最も頻繁に使用するデバイスのタイプ(デスクトップやモバイルなど)。
・ブラウザ : ChromeやFirefoxなど、ユーザーが最も頻繁に使用するブラウザ。
・OS : Linux、Mac OS X、Windows など、ビューワーが最も頻繁に実行するOS。
・ロケーション : コンテンツに最も頻繁にアクセスするビューワーの場所 (国、州)
4. 人気オブジェクトレポート
5. トップリファラレポート


## Elastic Load Balancing
  - ALB、ELB、NLBで出来る事出来ない事
  - ASG、EC2を含めたデータの流れ、Connection Draining、証明書を使ったデータの暗号化、X-Forwarded-For
### スティッキーセッション
　複数のEC2インスタンスを起動している場合、Cookie を使用してユーザーのリクエストを追跡し、後続のリクエストを同じインスタンスに送信し続ける機能。
　（どのインスタンスにリクエストするかわからないので、スティッキーセッションを設定しないと、ユーザは再ログイン（セッションの頻繁な切断）を頻繁に求められる。）
### アクセスログ
アクセスログの有効化によって、ELBへのリクエストに関する情報を収集できる。
### HTTP応答コードのメトリクス
- HTTPCode_ELB_5XX : ロードバランサーが応答を解析できなかった場合。
- HTTPCode_Backend_4XX : 登録済みインスタンスからクライアントエラー応答が送信された場合。(存在しないリソースにアクセスして404がとなった場合や、Web APIに於いて必須のパラメータが足りなかった場合の400レスポンス等)
- HTTPCode_Backend_5XX : 登録済みインスタンスからサーバーエラー応答が送信された場合。ELB自体に問題が起きた場合、ELB配下に正常(healthy)なインスタンスが1つも無い場合
### AutoScaling
マルチリージョンに利用できない。
1つのリージョン内でマルチAZで利用できる。

# 分野 3: デプロイとプロビジョニング 14%
## ElasticBeanstalk
## Opsworks

## Cloudformation(重要)
  - (変更セットやドリフト等、スタック管理の機能やテンプレートの理解(セクション、組み込み関数)
CloudFormationがスタック作成に失敗した場合、スタックは自動的にロールバックされる。
### スタックの更新方法（2通り）
1. 直接更新を実施する
更新をスタックにすぐにデプロイしたい場合。  
テンプレートを送信するか、スタック内のリソースに対して更新を指定する入力パラメータを送信するとCloudFormationによりすぐにデプロイされる。
2. 変更スタックを設定して実行する
変更セットによってスタックを更新する。（スタックを削除して新しいスタックを作成するのではなく）  
変更セットを使用すると、スタックの変更案が実行中のリソースに与える可能性がある影響 (変更によって重要なリソースが削除されたり置き換えられたりしないか等) を確認できる。
### リソース属性
- CreationPolicy属性
アクションが完了した後にのみ、CloudFormationがスタックの作成を続行できるように設定が可能。
- DependsOn属性
特定のリソースが他のリソースに続けて作成されるように指定できます。DependsOn属性をリソースに追加した場合、そのリソースの作成は必ず、DependsOn属性で指定したリソースの作成後に行われます。(dockerのdependsに近い)
- UpdatePolicy属性
新バージョンの更新する際に事前処理などを指定することで、ダウンタイムを抑える対応を実施することが可能。
（例：CloudFormationスタックが更新されるときのAutoScalingグループリソースの更新方法を定義。）
- AutoScalingRollingUpdateポリシー
CloudFormationがAutoScalingグループのローリング更新を処理する方法を制御できます。この共通的なアプローチでは、同じAutoScalingグループを保持し、設定したパラメータに基づいて古いインスタンスの置き換えを行います。 
- UpdateReplacePolicy属性
スタック更新オペレーションでリソースを置き換えるときに、リソースの既存の物理インスタンスを保持したり、必要に応じてバックアップしたりします。
- DeletionPolicy属性
スタックが削除された際にリソースを保持または (場合によっては) バックアップできます。
### cfn-signalヘルパースクリプト
CloudFormationに信号を送り、EC2インスタンスが正常に作成または更新されたかどうかを示す。
つまり、cfn-signalヘルパースクリプトの信号を確認して、直前のタスクが終了したのを確認した上で、次のリソース設定を始めることが可能。
### CloudFormationに依存してリソースをプロビジョニングするサービス
（プロビジョニング : 需要を予想しリソースを調達すること。 サイトアクセス数を見積もってそれに応じたスペックのEC2インスタンスでWebサーバを用意する等）
- Elastic Beanstalk
- SAM（サーバーレスアプリケーションモデル）

