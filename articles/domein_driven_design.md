---
title: "ドメイン駆動設計入門"
emoji: "🐶"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ドメイン駆動設計", "DDD"]
published: false
---

# 書籍
https://www.shoeisha.co.jp/book/detail/9784798150727

この書籍は、ドメイン駆動設計において重要な`モデリング`、`パターン`の内、**パターンを重点的に説明している**。
パターンを理解することで、モデリングを含めたドメイン駆動設計という大きなテーマを理解する準備ができる。

- **モデリング** : ソフトウェアにとって重要な概念を抽出するためのもの。
- **パターン** : 概念を実装に落とし込むためのもの。

:::message
**知識は連鎖する。**
:::

# 目的
本書を読む理由は、[エリック・エヴァンスのドメイン駆動設計](https://www.shoeisha.co.jp/book/detail/9784798126708)を理解・読破するため。
難解だと聞いたため、いきなり挑む前に本書でドメイン駆動設計の基本を理解することを目的としている。

# Gitリポジトリ
本書に登場するJavaのコードの**一部**を、「Rubyで表現してみる」「動かす 」ためのコードを置いています。
https://github.com/ito0804takuya/domein-driven-design

# ドメイン駆動設計とは
## ドメイン駆動設計のコンセプト
ビジネスの問題を解決するためにビジネスの理解を進め、ビジネスの表現をする。
**ビジネスとコードを結びつけて**、継続的な改良ができるように枠組みを作ることで、ソフトウェアをより役立つものにする。

## ドメインとは
ドメインとは**プログラムを適用する対象となる領域**のこと。 (ドメインの和訳 = *領域*)

重要なのは、ドメインとは何か でなく、ドメインに含まれるものが何なのか。
つまり、**システムで問題を解決する上で重要な知識は何か。**

## モデル、モデリングとは
モデルとは、現実の事象や概念を抽象化した概念。
抽象とは、抽出して象る(かたどる)ため、現実を忠実に再現しない。

では何を抽出したらいいのか？
例えば、物流システムにおいて、トラックは`貨物を運ぶもの`と表現すればいい。
`キーを回すとエンジンが動く`ということは不要。

**モデリング**とは、こういうように**事象・概念を抽象化する作業**のことを言う。
モデリングをした結果得られる結果がモデル。
(ドメイン駆動設計では、ドメインの概念をモデリングして得られたモデルをドメインモデルと言う。)

## ドメインオブジェクトとは
ドメインオブジェクトとは、**ドメインモデルをソフトウエアで動くモジュールとして表現（実装）したもの。**

ドメインで起こった変化は、ドメインモデルを媒介として、ドメインオブジェクトに伝えられる（変更される）。
`ドメインの概念 ⇔ ドメインモデル ⇔ ドメインオブジェクト`

# 値オブジェクト
システム固有の値を表現するために定義したオブジェクト。

## なぜ値オブジェクトを使うのか
システムで必要な処理にしたがって、**システムならではの値の表現があるため(それを表現するため)**。

#### 具体例 : 名前
例えば名前の姓を表現するとき、プリミティブな値では、色々な国の人の名前を表現することが難しい。
*※ プリミティブ : intやstringなど、言語が元々用意してくれている型のこと。*
```ruby:プリミティブな値
fullname = "山田 太郎"
lastname = fullname.split(' ')[0] # 姓
p lastname # 山田

fullname = "john smith"
lastname = fullname.split(' ')[0] # 姓
p lastname # 姓はsmithなのに、johnと出力されてしまう
```

```ruby:値オブジェクト
class Fullname
  attr_accessor :firstname, :lastname

  def initialize(firstname:, lastname:)
    @firstname, @lastname = firstname, lastname
  end
end

fullname = Fullname.new(firstname: "太郎", lastname: "山田")
p fullname.lastname # 山田

fullname = Fullname.new(firstname: "john", lastname: "smith")
p fullname.lastname # smith
```

## どこまで値オブジェクトにするか
例えば、上では`名前(姓名)`はオブジェクトにしたが、`姓`と`名`は別々のオブジェクトにすべきか？
→それはシステムによって異なる。
:::message
#### 値オブジェクトにするか（値クラスを作るか）どうかを判断する基準
1. **そこにルールが存在するか**
2. **それ単体で扱うことがあるか**
:::

## 値オブジェクトを使うモチベーション
### 1. 表現力が増す
**定義したクラスを見ることで、その値オブジェクトがどういったものであるかが分かる**。
(= **自己文書化**される。)

また、**独自の振る舞いを定義できる**。
### 2. 不正な値を存在させない
クラス内でバリデーションを設けることができるため、システム内に不正な値が存在しない。
(値オブジェクトにしない場合、使用する箇所すべてで不正な値でないかチェックしないといけなく、1箇所でも修正されないと**破綻**が起きる。）
### 3. 誤った代入を防ぐ
```ruby
class User
  attr_accessor :id

  def self.create_user(name)
    user = User.new()
    user.id = name # 正しい代入?
    user
  end
end

user = User.create_user("田中")
```
このコードで、`id`に`name`が代入されていることは、正しいのか分からない。
(システムによっては、名前がidになっている可能性も捨てきれないため。)
UserIdオブジェクトを`id`プロパティに定義していれば、何が代入されるべきかが明確に分かる。

(Rubyでは3.0以降でRBS(Rubyの型定義のための言語)を使えば、IDEで型エラーを見つけれれるはず。)
### 4. ロジックの散在を防ぐ
ルールをクラス内でまとめることができる。

:::message
**ドメイン駆動設計によってドメインの知識をコードに落とし込むことで、コードがドキュメントとして機能し始める。**
:::

# エンティティ

<!-- TODO: 01.ドメインモデル貧血症！というコード例 -->
<!-- TODO: 02.ドメインモデルに拘るとどんな現実的な問題がでてくるのか？ -->