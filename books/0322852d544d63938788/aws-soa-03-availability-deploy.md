---
title: "AWS SOA 高可用性 / デプロイとプロビジョニング"
emoji: "⛴"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["AWS","SOA"]
published: false
---

# 分野 2: 高可用性 8%

## Route53
DNS（＝ドメイン名とIPアドレスを変換（名前解決）するシステム）。
[参考サイト](https://zenn.dev/naoki_mochizuki/articles/d0d9fd2459250baeb37d)
- AutoScalingを直接指定できない。**Route53はELBに対して構成する**。
### レコード情報
- **Aレコード（ホスト名とIPアドレスの関連づけを定義）**
- **AAAAレコード（IPv6 のAレコード）**
- CNAMEレコード（正規ホスト名に対する別名を定義）
- MXレコード（メールサーバーのホスト名を定義）
- NSレコード（ネームサーバー）
- SOAレコード（管理情報の始点レコード）
- **ALIASレコード**：**AWSサービスのエンドポイント**のIPアドレス
### トラフィックルーティング
- レイテンシールーティング
  レイテンシーが最も低いリージョンからのリクエストを処理。
- フェイルオーバールーティングポリシー
  アクティブ/パッシブフェイルオーバーを構成する場合に使用。
### Evaluate Target Health
Evaluate Target Healthフラグを有効化にすると、**ELBのヘルスチェックによってELBの背後にあるEC2インスタンスのレイテンシーを確認して、最適なルーティング**（低レイテンシーが可能なインスタンスへのトラフィック処理の継続）を実施する。
### ヘルスチェック
応答が返ってくるかをチェックする ヘルスチェック をRoute53で作成できる。タイプが3種類ある。
1. **エンドポイント**をモニタリングするヘルスチェック
  IPアドレスあるいはドメイン名で特定するエンドポイントをモニタリング。
2. **他のヘルスチェック**を監視するヘルスチェック
  複数のリソースに対して各ヘルスチェックを用意した状況の場合、それら各ヘルスチェックをチェックし、しきい値より下回らないか確認。
3. **CloudWatchアラーム**をモニタリングするヘルスチェック

-----

## CloudFront
CDN。画像や動画をキャッシュ。
### キャッシュヒット率の改善
- クエリ文字列パラメータに基づいてキャッシュするよう、**オリジンが一意のオブジェクトを返すクエリ文字列パラメータ**のみを転送するように設定。
- **Cache-Control max-ageディレクティブ**をオブジェクトに追加し、max-ageに対して最も長い実用的な値を指定。
### 有効期限が切れる前にエッジキャッシュからファイルを削除したい場合
  aws cloudfront create-invalidation(無効化)コマンドを使用して、エッジキャッシュのファイルを無効化する。
### レポート
1. キャッシュ統計レポート
　エッジロケーションに関連する統計をグラフ表示。
2. 使用状況レポート
　HTTPおよびHTTPSリクエスト数を確認。
3. ビューワーレポート
　物理デバイス+コンテンツにアクセスするビューワーに関する以下の4つのレポートを表示。
・デバイス : ユーザーが最も頻繁に使用するデバイスのタイプ(デスクトップやモバイルなど)。
・ブラウザ : ChromeやFirefoxなど、ユーザーが最も頻繁に使用するブラウザ。
・OS : Linux、Mac OS X、Windows など、ビューワーが最も頻繁に実行するOS。
・ロケーション : コンテンツに最も頻繁にアクセスするビューワーの場所 (国、州)
4. 人気オブジェクトレポート
5. トップリファラレポート
### AWS Nitro Enclaves
**オリジンがELBロードバランサー以外**の場合、信頼されたサードパーティー認証機関 (CA)によって署名された証明書を使用する必要があり、これまではサードパーティーの証明書を利用する必要があった。
しかし、**AWS Nitro Enclavesを使って、ACMで発行したSSL/TLS証明書を使用できる**。

上は、**CloudFrontとカスタムオリジン間** のHTTPS の話。
**ビューアとCloudFront間**の HTTPS は、ACMが提供する証明書 or 認証局（CA）によって発行された証明書を使用できる。

-----

## Elastic Load Balancing
- **ELBはリージョンをまたげないので、Route53を使用**する。
- NLBはPre-warming申請が不要。
### X-Forwarded-Forリクエストヘッダー
**クライアントのIPアドレスを識別**するのに利用。
このヘッダーで**トラフィックをフィルタリングできる**。
### スティッキーセッション
複数のEC2インスタンスを起動している場合、**Cookieを使用してユーザーのリクエストを追跡し、後続のリクエストを同じインスタンスに送信**し続ける機能。
（どのインスタンスにリクエストするかわからないので、スティッキーセッションを設定しないと、ユーザは再ログイン（セッションの頻繁な切断）を頻繁に求められる。）
### Connection Draining
サーバがELBから離脱してもセッションを持ち続ける機能。
**ELBから切り離しても、まだリクエスト中のインスタンスへ指定秒数の間は通信は切れない**。
(新規にリクエストがあっても、既に切り離されたインスタンスへのアクセスはできない。)
デフォルト：*300秒*。最大タイムアウト値は *1 〜 3,600 秒*の間で設定できる。
### アクセスログ
アクセスログの有効化によって、ELBへのリクエストに関する情報を収集できる。
### HTTP応答コードのメトリクス
- HTTPCode_ELB_5XX : ロードバランサーが応答を解析できなかった場合。
- HTTPCode_Backend_4XX : 登録済みインスタンスからクライアントエラー応答が送信された場合。(存在しないリソースにアクセスして404がとなった場合や、Web APIに於いて必須のパラメータが足りなかった場合の400レスポンス等)
- HTTPCode_Backend_5XX : 登録済みインスタンスからサーバーエラー応答が送信された場合。ELB自体に問題が起きた場合、ELB配下に正常(healthy)なインスタンスが1つも無い場合
### さばききれなかったアクセス管理
- SpilloverCount
  サージキューがいっぱいとなり**拒否されたリクエスト**の総数を取得。
- SurgeQueueLength
  正常なインスタンスへのルーティングを**保留中のリクエスト** (HTTPリスナーまたはTCPリスナー) の合計数。
- RequestCount
  指定された間隔(1分または5分)の間に完了したリクエストの数または接続の数。
- UnHealthyHostCount
  ロードバランサーに登録された異常なインスタンス数。
### セキュリティポリシー
- Server Order Preferenceが有効になっているポリシー : ELBはポリシーで指定されている順序で暗号化を実施。
- それ以外の場合 : ロードバランサーはクライアントによって提示された順序で暗号を使用します。
## AutoScaling
**マルチリージョンに利用できない。1つのリージョン内でマルチAZで利用できる。**
#### 一定期間メトリクスが取得できなくなる場合
ステップスケーリングポリシーを使用した場合。（ウォームアップ中）
指定されたウォームアップ時間が経過するまで、新しく起動されたインスタンスはAuto Scalingグループの集約メトリックにカウントされないため。
#### データベースサーバーをインターネットからのアクセスから保護する場合
WEBサーバーはパブリックサブネットに設置し、DBサーバーはプライベートサブネットに設置する2層アーキテクチャーが一般的な構成。
その際に**ALBなどのロードバランサーを両方のサブネットに設定**します。
（リクエストの流れ：パブリックのロードバランサー→WEBサーバー→プライベートのロードバランサー→DBサーバー）
#### AddToLoadBalancer
AutoScalingによってインスタンスが追加されたとき、**インスタンスをELBのターゲットグループに設定する機能**。
しかし、これを中断している最中にAutoScalingによってインスタンスが追加されると、それらのインスタンスはロードバランサーやターゲットグループに追加されません。
AddToLoadBalancerプロセスを再開すると、**このプロセスが中断されている間に起動されたインスタンスは**追加されないままとなりますので、これらのインスタンスは**手動で登録する必要**があります。

-----

# 分野 3: デプロイとプロビジョニング 14%

## 用途の違い
- ElasticBeanstalk
  WEBアプリケーションのデプロイと管理を自動化する。
- Opsworks
  サーバーのパッチ適用、アップデート、バックアップが自動的に実行される。
- Cloudformation
  サーバーのパッチ適用、アップデート、バックアップは自動化できない。（Opsworksはする）

## ElasticBeanstalk
負荷分散、オートスケーリング、リソースのモニタリング、クラスター全体へのコンテナの配置などを自動で実行。
### ログについて
- 環境管理コンソールまたはeb logs を使用して**ログ末尾をリクエストすると、ログをテキストファイルにまとめてS3にアップロード**する。**S3へのログローテーションを有効化**することも可能。
（→S3バケットへのアクセス権限を限定して対象者にログファイルのみを閲覧させることもできる。）
- **CloudWatch Logsへログをリアルタイムでストリーミング**することもできる。

-----

## Cloudformation(重要)
CloudFormationがスタック作成に失敗した場合、スタックは自動的にロールバックされる。
### ドリフト
  テンプレート と 展開したインフラ との相違点。
  スタックでドリフト検出オペレーションを実行すると、スタックが予想されるテンプレート設定からドリフトしたかどうかが判断され、ドリフト検出をサポートするスタック内の各リソースのドリフトステータスに関する詳細情報が返されます。
### セクション
- Resources
  スタックに含めるAWSリソースを宣言。必須。
- Mappings
  リージョンに応じてAMIを選択することが可能。
- Outputs
  他のスタックにインポートする (クロススタック参照を作成)、応答として返す (スタック呼び出しについて記述)、またはCloudFormationコンソールで表示する出力値を宣言。
- Conditions
  エンティティが作成または設定される状況を定義。
  たとえば、条件を作成し、それをリソースまたは出力に関連付けることで、条件がtrueの場合にのみ、CloudFormationがリソースまたは出力を作成するようにできる。
### スタックの更新方法（2通り）
1. **直接更新**を実施する
  更新をスタックにすぐにデプロイしたい場合。  
  テンプレートを送信するか、スタック内のリソースに対して更新を指定する入力パラメータを送信するとCloudFormationによりすぐにデプロイされる。
  インフラ構成が正しくプロビジョニングされ、かつサービスの中断を回避する必要がある場合には不適合。
2. **変更スタック**を設定して実行する
  変更セットによってスタックを更新する。（スタックを削除して新しいスタックを作成するのではなく）  
  変更セットを使用すると、スタックの変更案が実行中のリソースに与える可能性がある影響 (変更によって重要なリソースが削除されたり置き換えられたりしないか等) を確認できる。
### リソース属性
- **CreationPolicy属性**
  **アクションが完了した後にのみ、CloudFormationがスタックの作成を続行できる**ように設定が可能。（例：インスタンスが動いていることを確認してから、○○する。）
  - ResourceSignalパラメーター
    Timeoutプロパティを追加することで、前提条件となるAWSリソースが起動されるまでのタイムアウト時間(待機時間)を設定できる。
- **DependsOn属性**
  特定のリソースが他のリソースに続けて作成されるように指定できます。DependsOn属性をリソースに追加した場合、**そのリソースの作成は必ず、DependsOn属性で指定したリソースの作成後**に行われます。(dockerのdependsに近い)
- **UpdatePolicy属性**
  新バージョンの更新する際に事前処理などを指定することで、**ダウンタイムを抑える**対応を実施することが可能。
  （例：CloudFormationスタックが更新されるときのAutoScalingグループリソースの更新方法を定義。）
- AutoScalingRollingUpdateポリシー
  CloudFormationがAutoScalingグループのローリング更新を処理する方法を制御できます。この共通的なアプローチでは、**同じAutoScalingグループを保持し、設定したパラメータに基づいて古いインスタンスの置き換え**を行います。 
- **UpdateReplacePolicy属性**
  スタック更新オペレーションでリソースを**置き換えるとき**に、リソースの**既存の物理インスタンスを保持**したり、必要に応じて**バックアップ**したりします。
- **DeletionPolicy属性**
  スタックが**削除された**際に**リソースを保持またはバックアップ**できます。
### ヘルパースクリプト
スタック内のEC2インスタンスの構築・変更を行うためのもの。
- cfn-init
  AWS::CloudFormation::Initキーからテンプレートメタデータ(変数)を読み取り、それに応じて次のような操作を行います。（現在は、**SystemsManagerのStateManagerの利用が推奨**されている。）
  ・AWS CloudFormationのメタデータの取得と解析
  ・パッケージのインストール
  ・ディスクへのファイルの書き込み
  ・サービスの有効化/無効化と開始/停止 
- cfn-get-metadata
  **CloudFormationリソースからメタデータを取得**できる。
- cfn-signal
  CloudFormationに信号を送り、EC2インスタンスが正常に作成または更新されたかどうかを示す。
  つまり、**cfn-signalヘルパースクリプトの信号を確認して、直前のタスクが終了したのを確認した上で、次のリソース設定を始める**ことが可能。
  (例：リソース作成開始から30秒以内にシグナルが飛ばない場合、ロールバックする みたいに使う。)
- cfn-hup
  **リソースのメタデータの変更を検出し、変更が検出された場合は、ユーザーが指定した操作を実行するデーモン**。
  これによって、実行中のEC2インスタンスで UpdateStack APIアクションを通じて設定を更新することができます。
### CloudFormationに依存してリソースをプロビジョニングするサービス
（プロビジョニング : 需要を予想しリソースを調達すること。 サイトアクセス数を見積もってそれに応じたスペックのEC2インスタンスでWebサーバを用意する等）
- **Elastic Beanstalk**
- **SAM（サーバーレスアプリケーションモデル）**
### スロットリングエラー
- スロットリングとは : 一定時間内に受信可能なリクエスト数を制限し、制限を上回るリクエストがなされた際には受信を拒否しエラーコードを返却すること。時間経過により再び受信可能となる仕組み。
- 原因 : スタック作成用のAPIが同時に多くのリソースを作成していること。
- 対処 : 指数バックオフと呼ばれる処理方法を使用して、リクエスト間に遅延を追加する。
  
