---
title: "AWS SOA セキュリティとコンプライアンス / ネットワーク"
emoji: "🔑"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["AWS","SOA"]
published: false
---

# 分野 5: セキュリティとコンプライアンス 18%

## IAM ※特に重要
### IAMロール
一時的にアクセスを許可。
  - 権利の委譲
  - **原則：アクセスキーよりIAMロール**
### IAMポリシー
IDやリソースに関連付けてアクセス許可を定義。
- IDベースのポリシー
  IAMユーザー、グループ、ロールにアタッチ。
  そのアイデンティティが実行できる内容 (そのアクセス許可) を指定できる。
- リソースベースのポリシー
  リソースにアタッチ。
  特定のIAMユーザーやアカウントに対するアクセスを制御できる。たとえば、バケットポリシーをS3バケットにアタッチして、アクセスするIAMユーザーを限定することができる。
### サービスコントロールポリシー (SCP) 
組織を管理するために使用できるポリシーのタイプ。
リソースのアクセス権限を組織単位でコントロールすることに利用。（ユーザー単位ではない）

SCPをOU(組織単位)にアタッチする(ガードレールを敷く) + IAMポリシーを付与(実際に権限を与える)  
→  IAMユーザーの操作権限は、SCPとIAMの両方で許可されている場合に対象リソースの実行が可能。
つまり、**両方で 明示的に許可され かつ 明示的に拒否されていない** 場合に許可される。
##### 例
- SCP：EC2とRDSの全ての操作権限が許可
- IAMポリシー：EC2の削除権限のみをDeny、その他のEC2操作をAllow
→ 両方が明示されている「EC2インスタンスの削除以外の操作のみ」が実施できる。
### パワーユーザー
管理者権限以外のあらゆるAWSリソースに対する権限を有したユーザー。
（フルアクセスは、管理者権限も持つ。）
### AWS CLIを操作するために必要な情報
- アクセスキー
- シークレットアクセスキー
- リージョン


## Certificate Manager(ACM) 
- ACMがサポートされていないリージョンでは、IAM を Certificate Manager として使用する必要がある。
- IAM APIを使用して証明書を取得するには、get-server-certificateコマンドを使用して、証明書のARNを取得。
- 取得した証明書をELBに設定するためには、set-load-balancer-listener-ssl-certificateコマンドを使用して証明書を設定。
- ACMは期限切れ前に自動的に証明書を更新する。
- ACMはELBと統合して、ロードバランサーに証明書をデプロイできる。

## AWS Shield
マネージド型の**分散サービス妨害(DDoS)を防御**するAWSサービス。

**<注> SQLインジェクション、クロスサイトスクリプティング（XSS）、DDoS攻撃への対応としては、AWS Shield とWAFによる対応が不可欠。**
- スタンダード
  無料。通常、Cloudfrontなどを利用すると自動で適用される。
- アドバンスト
  アプリケーションを標的とした攻撃に対する高レベルな保護。**リアルタイムのモニタリング**が必要な場合に使用。

## WAF
ウェブエクスプロイトからウェブアプリケーションを保護するために役立つファイアウォール。
ルールを設定してルールがマッチしたアクセスを遮断する機能。（*監視はできない。*）
- 守れるもの
　・SQLインジェクション攻撃
　・クロスサイトスクリプティング攻撃
　・OSコマンドインジェクション攻撃
　・DDoS攻撃

AWS **WAFはOSI参照モデルの7層**で行われるDDos攻撃を緩和できますが、
AWS **Shieldは3層および4層**で行われるDDos攻撃からWebサービスを防御します。

## インポートキーペア
利用している**キーペアの複製を別リージョンに移行**することで、既存キーペアを利用できる。
（AMIを新しいリージョンにコピーしてインスタンスを作成すると、別のリージョンで作成した既存のキーペアを選択することができません。そのため、基本的には新しいリージョンでは新規キーペアを作成することになります。しかしながら、現在のリージョンで利用しているPEMキーを共有したいという場合は、**PEMキーを別リージョンにインポートすることができます**。）

## 暗号化
- サーバサイド暗号化：オブジェクトを保管時に暗号化する場合。
### CSE (Client Side Encryption)
クライアント内で暗合化したオブジェクトをS3に登録して、暗号化キーの生成と管理はクライアント側で実行します。
### SSE-C (サーバサイド)
AWS側の暗号化キーではなく、ユーザが作成・管理する暗号化キーによって暗号化を実行。
### SSE-S3 (サーバサイド)
AWS S3で管理された暗号化キーによるサーバーサイド暗号化。
### AWS KMS
  AWSサービスとしてキーの作成と管理をマネージド型サービスで提供。
- キーポリシー
  KMSの発行するカスタマーマスターキーにアクセスできるユーザーを管理・変更できる。
### AWS CloudHSM
  **大規模システム用**。**KMSではダメな、特殊な場合**に使う。
### NGなパターン
- 暗号化キーを、暗号化されたデータと一緒に保存。（一方が侵害された場合のセキュリティリスクが高い）
- 外部ハードウェアデバイスに暗号化キーを保存。（そのハードウェアが侵害された場合）

## セキュリティに関する 設計原則とベストプラクティス
### 7つの設計原則
1. 強固な認証基盤の整備
2. 追跡可能性の実現
3. 全レイヤーへのセキュリティ適用
4. セキュリティのベストプラクティス自動化
5. 転送中および保管中のデータの保護
6. データに人を近づけない
7. セキュリティイベントに対する準備
### 5つのベストプラクティス
1. アイデンティティとアクセス管理
2. 発見的統制
3. インフラストラクチャ保護
4. DDos攻撃を緩データ保護
5. インシデント対応


# 分野 6: ネットワーク 14%

**原則：セキュリティグループは、許可のみ行う。ステートフル**  
**原則：ネットワークACLは、明示的な拒否を行う。ステートレス**
特定のポートを介した特定のIPアドレスからの攻撃に対しては、*ネットワークACL*で防御。

## VPC(IGW, NAT, VPCエンドポイント)
- **IPv6 CIDRブロックのサイズ(/56)は固定**。(独自のIPv6アドレス範囲を指定できない)
### VPCピアリング
2つのVPC間をセキュアに通信できる。
（例：異なるアカウントによって所有され、かつ別のリージョンのVPCで稼働されているインスタンス に、パブリックインターネットを通過せずにアクセスできる。）
### ルートのブラックホール状態(現象)
ルートのターゲットが利用できない状態。
**ルートテーブルに設定したインターネットゲートウェイやNATゲートウェイを削除**すると発生。
### VPCエンドポイント
VPC外のサービス(S3、DynamoDB)と接続する場合に使用。
### NATゲートウェイ
プライベートサブネットからセキュアにインターネットへ通信するために、パブリックサブネットに配置するもの。
設定は、**プライベートサブネットのEC2インスタンスのアウトバウンドを、NATゲートウェイに送信する**ようにする。
### Egress-only Gateway (Egress-onlyゲートウェイ)
**IPv6**を使用してインターネットに出たいときに使用するもの。(IPv6とくればコレ)
しかし、インターネットへのEgress(送信)のみでIngress(受信)はできません。
（NATゲートウェイのIPv6バージョンのようなもの。）
### AWS上のリソースに外部ネットワークへの接続を提供するもの
- インターネットゲートウェイ(IGW)
- 仮想プライベートゲートウェイ(VGW) **<オンプレに繋げる>**
  - DirectConnect
  - VPN
    - AWSのVPN接続には、デフォルトで**2つのVPNトンネル**が利用される。これは最初のVPNトンネルに障害が発生した場合やメンテナンスにより停止している場合などに自動的に2番目のVPNトンネルにフェイルオーバーするように設定されている。 
    - VPNゲートウェイとカスタマーゲートウェイの作成が必要。

## Guard Duty
セキュリティの観点から、VPCフローログなどのトラフィックデータを機械学習などを利用して自動で解析して、不正なアクセスを**検知**。(トラフィック制御はできない)
- **機械学習を利用した不正検知**が可能です。 
- **VPCフローログを解析**できます。 
- **IPアドレスやドメインリストを解析**できます。 